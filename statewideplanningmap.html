<!DOCTYPE html>
<!--v01 - template with header, toc, map, and layout for all components-->
<!--v02 - Added scale bar, map coordinates, measure, LRS readout, and Jump to google-->
<!--v03 - Added map reset, management of bottom right info div during reset, management of buttons during reset, applied styles to LRS table results, export LRS table results-->
<!--v04 - Added URL parameters for page startup (tab, basemap, overlays, lat/long/zoom location), added graphics layer for LRS readout clicked point -->
<!--v05 - Added selectable basemaps, logic controls for tab selection, logic controls for map tools-->
<!--v06 - Added div for base maps and overlays, toggle between choices to display different basemaps-->
<!--v07 - Added controls to toggle content between tabs, accept parameters to control tabs, re-organized code-->
<!--v08 - Added Query Builder functionality to query tab, added roadway inventory layer to map, sketch tab with calculations and line drawing -->
<!--v09 - Added drag and drop support for CSV event tables-->
<!--v10 - Added an event to the URL parameters (&event=IH0035-KG,15,30,Red,6,Expand to 8 lanes|US0290-KG,45,55,Blue,6,Test), added point to the URL parameters (&point=30,-97,Blue,12,Test)-->
<!--v11 - Added an Event tab to the table of contents, added Export to KML-->
<!--v12 - Added Diagram tab to the table of contents, added remove last, remove all, and generate URL buttons to Events tab, encoded/decoded "#" in color used to generate URL string-->
<!--v13 - Added ability to toggle the table div in the Query tab, standardized TOC forms, cleaned code comments/spacing/formatting-->
<!--v14 - Added general purpose div for displaying URLs to share, reorganized/worded a few form buttons-->
<!--v15 - Added a view/hide button to the SRD form, add LRM identify click event to populate Route, DFO From and to from map is SRD tab is active, add the route event to the map when diagram is created, added zooms to graphics extent or query extent when executed-->
<!--v16 - Added Share URLs and Right click map/coordinates to clipboard via javascript-->
<!--v17 - Added Share URL for Query tab, cleaned UI and CSS, updated URL parameters to accept Query by URL-->
<!--v18 - Added Share URL for Diagram tab, updated URL parameters to accept Diagram by URL, updated point identify to not remove all graphics (just the last point if other line graphics are drawn), updated Table Show/Hide logic-->
<!--v19 - Added Reference Markers to diagram, Added test for multiple control sections in Diagram (if more than 1, no CS laels shown), added clear button to diagram form, added loading control section message to diagram-->
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
        <title>TxDOT - Statewide Planning Map</title>
        <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
        <script src="https://js.arcgis.com/4.26/"></script>         
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
            /* Media Queries */
            /*Mobile Devices*/
            @media (max-width: 480px){
              #left-div{
                display: none;
                background-color: red !important;
                z-index: 2 !important;
              }
              .hamburgler{
                display: block !important;
              }
              #viewDiv{
                width: calc(100vw - 0px) !important;
                left: 0px !important;
              }
              #queryMessageBtn{
                margin-left:  16.6rem !important;
              }
            }
            /*Tablets*/
            @media (min-width: 481px) and (max-width: 767px){
              #left-div{
                display: block;
                background-color: yellow !important;
              }
            }
            /* Tablets portrait mode */
            @media (min-width: 768px) and (max-width: 1024px){
              #left-div{
                display: block;
                background-color: blueviolet !important;
              }
              
            }
            /* Laptops, Desktops, tablets landscape mode */
            @media (min-width: 1025px) and (max-width: 1280px){
              #left-div{
                display: block;
                background-color: blue !important;
              }
            }
            /* Large screens */
            @media (min-width: 1281px){
              #left-div{
                display: block;
                background-color: green !important;
              }
            }
           /* //END Media Queries */
            #printWidget{
              position:relative;
              top: 5rem;
            }
            .queryStatus{
              display: flex;
              flex-wrap: wrap;
              background-color: rgba(245, 245, 245, 1);
              position: relative;
              z-index: 1;
              max-width: 23%;
              left: calc(50vw - 11rem);
              top: 4vh;
              min-width: 23rem;
              overflow-y: auto;
              max-height: calc(100vh - 6rem);
            }
            #closeAbout{
              font-size: small;
              text-decoration: underline;
              color:#14375A;
            }
            #serviceDownDiv{
              position: absolute;
              z-index: 3;
              left: 40%;
              top: 5%;
              height: 2.5rem;
              width: 35%;
              color: white;
              border-radius: 5px;
              padding: .5rem;
            }

            #queryMessageBtn{
              /* position: inherit; */
              /* bottom: .7rem;
              right: 1.4rem; */
              z-index: 1;
              margin-top: 1.3rem;
              margin-bottom: 1rem;
              margin-left: 21.6rem;
            }
            .esri-icon-notice-triangle{
              font-size: 1rem;
            }
            #queryMessagePara{
              /* position: inherit; */
              /* top: 3rem;
              left: 1.4rem; */
              font-size: 1rem;
              padding-left: 1.5rem;
              padding-right: 1.5rem;
              text-align: left;
            }
            .main{
              font-family: Roboto, Avenir, Helvetica, Arial, sans-serif !important;
              color:black !important;
              letter-spacing: .0008em;
              font-weight: 400;
              line-height: 1.375rem;
            }
            .dwnloadBtn{
              position: absolute;
              left: 83%;
              /* top: .33rem; */
              padding-top: .2rem;
              background: none;
              background-color: none;
              cursor: pointer;
              border: none;
            }

            .noDwnloadBtn{
              position:absolute;
              left: 83%;
              padding-top: .2rem;
              background: none;
              background-color: none;
              cursor: default;
              border: none;
              color: grey;
            }
            .dwnloadBtn:hover{
              color: green;
            }

            .invisible{
              visibility: hidden;
            }
            /* .mobileViewDiv{
              position: absolute !important;
              top: 30px !important;
              left: 1px !important;
              height: 97% !important;
              width: 100% !important;
              float: left !important;
              background-color: white !important;
              z-index: 1 !important;
            } */
            .esri-icon-collapse{
              rotate: 90deg;
              position: absolute;
              top: 20rem;
              left: 15rem;
            }
            #header {
                height: 44px;
                width: 100%;
                background-color: rgb(20, 55, 90);
                display: flex;
                justify-content: space-between;
                align-items: center;
                color: white;
            }
            .logo {
                font-size: 15px;
            }      
            a[class="links"]{
              position: relative;
              color: white;
              font-size: 14px;
              text-decoration: none;
              top: .4rem;
              padding-left: 2px;
            }

            a:hover{
              cursor: pointer;
            }
            /* #layerSearch{
              position: relative;
              width: 90%;
              left: .2rem;
            } */
            #left-div {
                position: absolute;
                left: 0px;
                top: 44px;
                width: 300px;
                height: calc(100vh - 44px);
                background-color: white;
                overflow-y: auto;
                overflow-x: hidden;
            }
            #left-div::-webkit-scrollbar {
              width: 1px;
            }       
            #viewDiv {
                position: absolute;
                top: 44px;
                left: 300px;
                height: calc(100vh - 44px);
                width: calc(100vw - 300px);
                float: left;
                background-color: white;
                z-index: 1;
            }
            .textArea{
              position: relative;
              border: .15rem solid rgba(70,130,180,.5);
              height: 3rem;
              bottom: .5rem;
              width: 2rem;
              left: 1rem;
            }
            .textArea:hover{
              cursor: pointer
            }
            #previewUrl{
              /* position: inherit; */
              width: 89%;
              /* right: 2.35rem;
              bottom: 4rem; */
              height: fit-content;
              resize: none;
              border: .12rem solid #204e70;
              text-align: left;
              padding-left: 10px;
              margin-left: 1.5rem;
              overflow-wrap: break-word;
              margin-right: 30px;
              padding-right: 10px;
            }
            #previewBtn{
              position: relative;
              left: .7rem;
              bottom: .3rem;
            }
            .esri-view .esri-view-surface--inset-outline:focus::after {outline: none !important;}    
            .esri-view .esri-zoom.esri-widget {
              position: absolute;
              top: 45px; /* move the buttons down by 45 pixels */
            }         
            .esri-scale-bar {
              position: absolute;
              bottom: 20px;
              left: 15;
            }          
            .toolsContainer {
              position: absolute;
              top: 15px;
              right: 12px;
              display: flex;
              flex-direction: column;
              align-items: center;
              z-index: 1;
            }
            .toolsChild {
              background-color: white;
              margin-left: 0px;
              margin-right: 3px;
              margin-bottom: 10px;
              padding: 8px;
              border-radius: 0px;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
              cursor: pointer;
            }

            .spmMainBtn{
              outline: #14375A;
              background-color: none;
              background: none;
              cursor: pointer;
              border: 1px #14375A solid;
              height: 2rem;
              width: 5rem;
              text-decoration: underline;
            }
            .spmMainBtn:disabled{
              background-color: none;
              background: none;
              cursor: default;
              border: 1px #888 solid;
              height: 2rem;
              width: 5rem;
              text-decoration: underline;
              pointer-events: none;
            }
            .spmMainBtn:active{
              background: rgba(20,55,90,.5);
            }

            .spmSecondaryBtn{ 
              background-color: none;
              background: none;
              cursor: pointer;
              border: 1px #14375A solid;
              height: 2rem;
              width: 5rem;
            }

            .spmSecondaryBtn:disabled{
              outline: #888;
              background-color: none;
              background: none;
              cursor: default;
              border: 1px #888 solid;
              height: 2rem;
              width: 5rem;
              pointer-events: none;
            }
            .spmSecondaryBtn:active{
              background: rgba(20,55,90,.5);;
            }
            .spmDropDown{
              border: 1px solid #14375A;
              background: none;
              border-radius: 0px;
            }
            .spmDropDown:disabled{
              border: 1px solid #888;
              color:#888;
              outline: #888
            }
            #modalHeader{
              /* position: inherit; */
              bottom: 1.6rem;
              color: white;
              background-color: #14375A;
              text-align: left;
              padding-left: 0rem;
              padding-right: 0rem;
              padding-top: .6rem;
              height: 2rem;
              width: 100%;
              right: .6rem;
              text-transform: uppercase;
              margin-top: 0rem;
              font-size: 15px;
              text-indent: 1.4rem;
            }
            #marginal {
                position: absolute;
                bottom: 12px;
                left: 12px;
                background-color: white;
                padding: 5px;
                border-radius: 5px;
                box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
                z-index: 1; 
                font-size: calc(9px + 0.390625vw);
            }      
            #mapClickResults {
                position: absolute;
                bottom: 12px;
                right: 12px;
                background-color: white;
                padding: 5px;
                border-radius: 5px;
                box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
                z-index: 1; 
                font-size: calc(9px + 0.390625vw);
            }         
            .tabsContainer {
              position: relative;
              top: 8px;
              right: 12px;
              width: 300px;
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 1;
            }
            .tabsChild {
              background-color: inherit;
              margin-left: 1px;
              margin-right: 5px;
              padding: 5px;
              /* border-radius: 5px; */
              /* box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2); */
              cursor: pointer;
              text-transform: uppercase;
              font-size: 15px;
            }
            
            .tabsChild:active{
              background-color: rgba(32, 78, 112, .4) !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            nav {
                position: absolute;
                right: 0px;
                top: 5px;
            }
            #resetMap {
              position: absolute;
              top: 134px;
              left: 13px;
              background-color: white;
              margin-left: 3px;
              margin-right: 3px;
              padding: 8px;
              border-radius: 0px;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
              cursor: pointer;
            }
            .hamburgler{
              position: absolute;
              top: 180px;
              left: 13px;
              display: none;
              border: none;
            }
            #rmvDiv{
              position: absolute;
              left: 83%;
              /* top: .33rem; */
              padding-top: .2rem;
              background: none;
              background-color: none;
              cursor: pointer;
              border: none;
            }

            .removeOverlay{
              position: relative;
              bottom: 0.07rem;
              left: 83%;
              background: none;
              background-color: none;
              cursor: pointer;
              border: none;
            }

            .removeOverlay:hover{
              color: red;
            }
            #searchTool {
              position: absolute;
              top: 15px;
              left: 13px;
              background-color: white;
              margin-left: 3px;
              margin-right: 3px;
              padding: 8px;
              border-radius: 0px;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
              cursor: pointer;
            }
            #searchBox{
              position: relative;
              top: 0.1rem;
              left: 3rem;
            }
            #searchBox input{

              border-radius: 5px;
              width: 100% !important;
              padding: 0px !important;
              border: 0px solid #ccc !important;
              resize: both !important;
              margin-bottom: 0px !important;
            }
            tr:nth-child(odd) {background-color: #ffffff;}
            tr:nth-child(even) {background-color: #f2f2f2;}
            th {text-align: left;}    
            #exportSpan {
              cursor: pointer;
              color: blue;
            }
            .tocTabs {
              position: absolute;
              top: 44px;
              left: 0px;
              width: 300px;
            }
            .tocTabsQuery, .tocTabsSketch, .tocTabsEvent, .tocTabsDiagram {
              position: absolute;
              top: 50px;
              left: 18px;
              width: 270px;
              /*border: 1px solid black;*/
            } 
            .eventTabInput {
              width: 80%;
            }
            #tocMaps {
              width: 300px;
              cursor: pointer;
              font-size: 13px;
            }
            #addFeatRow{
              position: relative;
              bottom: .5rem;
            }
            .basemapHeader {
              color: white;
              background-color: #204e70;
              text-align: left;
              padding-left: .3rem;
              font-size: 15px;
            }
            .baseMapList {
              color: black;
              font-weight: normal;
              padding-left: 1rem;
            }
            #mapTab,#queryTab,#diagramTab,#eventTab,#sketchTab {
              display: none;
            }
            .queryButtonClass {
                padding: 0.5rem;
                margin-bottom: 10px;
            }
            input[type=text], select, textarea {
              width: 97%;
              padding: 10px;
              border: 1px solid #14375A;
              /* border-radius: 4px; */
              resize: vertical;
              margin-bottom: 15px;
            }    
            input[type=number] {
              width: 89%;
              padding: 10px;
              border: 1px solid #14375A;
              /* border-radius: 4px; */
              resize: vertical;
              margin-bottom: 15px;              
            }
            input:invalid{
              border: 2px solid red;
            }

            input:disabled{
              border: 1px solid #888;
              color: #888;
            }

            tr:hover{
              background-color: rgba(32, 78, 112, .4);
              cursor: pointer;
              border: 1px solid black;
            }
            .dropDown{
              position: relative;
              display: block;
              overflow: hidden;
              width: 19rem;
            }

            .error{
              width: 100%;
              font-size: 1rem;
              color: white;
              background-color:#14375A;
              box-sizing: border-box;
              display: inline-block;
              text-align: center;
            }

            .error:active{
              padding: 2rem !important;
            }
            #value,#eventDescription,#eventRoute,#inpSRDRouteID,#inpSRDFromDFO,#inpSRDToDFO {
                width: 89%;
            }
            #btnAddCondition,#btnEventMap,#btnInventoryUpdateLRM,#btnUpdateLRM,#btnToggleTableView,#btnToggleDiagramView,#btnDiagramGenerateURL,#btnClearDiagramView {
                width: 97%;
            }   
            #btnRunQuery,#btnClearConditions,#btnRemoveLast,#btnRemoveAll,#btnCalcCost,#btnClearProject,#btnExportJPEG,#btnExportPNG,#btnExportToCSV,#btnQueryGenerateURL,#btnExportToKML,#btnGenerateURL {
              width: 48%;
            }
            #btnRunQuery{
              position:relative;
              left:8.4rem;
            }
            #btnRunQuery:disabled{
              pointer-events: none;
            }
            #btnClearConditions{
              position:relative;
              right: 8.3rem;
            }
            #results {
                position: absolute;
                top: 315px;
                left: 70px;
                right: 55px;
                bottom: 95px;
                background-color: #F8F8F8;
                display: none;
                overflow: auto;
                height: 30rem;
                border: 1px solid black;
            }
            .resizeTable{
              resize: both;
            }
            #parentCanvas {
                position: absolute;
                top: 25px;
                left: 70px;
                right: 55px;
                bottom: 95px;
                background-color: #F8F8F8;
                display: none;
                overflow: hidden;
            }             
            .queryTblData {
                border: 1px solid #F8F8F8;
                padding: 8px;
                text-align: left;
            }
            .queryTblHeader {
                border: 1px solid #F8F8F8;
                padding: 8px;
                text-align: left;              
                background-color: #14375A;
                color: white;
                font-weight: bold;
    	          cursor: pointer;
            }      
            .queryTableResults {
                border-collapse: collapse;
                width: 100%;
            }
            .cellHighlight{
              background-color: rgba(32, 78, 112, .4);
            }
            .queryBuilder{
              position: absolute;
            }

            #operatorBuilder{
              left: 7.5rem;
              top: 0%;
              width: fit-content;
            }
            #fieldBuilder{
              width: 4rem;
              word-wrap: break-word;
            }
            #valueBuilder{
              left: 11rem;
              top: 0%;
              width: fit-content;
            }
            section{
              position: relative;
              height: 4rem;
            }
            .modal {
        			display: none;
        			position: fixed;
        			z-index: 1;
        			left: 0;
        			top: 0;
        			width: 100%;
        			height: 100%;
        			overflow: auto;
        			background-color: rgba(0, 0, 0, 0.4);
        		}
        		.modal-content {
        			background-color: #fefefe;
        			margin: 15% auto;
        			/* padding: 20px; */
        			border: 1px solid #888;
        			width: 30rem;
        			border-radius: 0px;
              position: relative;
        		}
            .overlay{
              position: fixed;
              top: 0;
              bottom: 0;
              left: 0;
              right: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              z-index: 1;
            }
        		#spnClose {
              position: relative;
              bottom: .5rem;
              left: 23.5rem;
        		}
            
            
        </style>
        <script>
            var view;
            var map;
            var txdotLayer;
            let backupTxdotLayer;
            var roadwayInventoryfeatureLayer;
            var lightGrayLayer;
            var darkGrayLayer;
            var imageryLayer;
            let itemArr = []
            var streetsLayer;  
            var featureLayer;
            var featureLayerView;
            var theQuery="";
            var queryTask;
            var query;  
            var lrsButtonStatus=false;
            var graphicsLayer;
            var graphicsLayerLRSIdentify;
            let bridgeInventoryFieldsArray = []
            //let searchSources = []
            let basemapAll;
            let queryTableResults;
            
            // URL Parameters
            var urlParams;
            var basemapParam;
            var overlayParam;
            var tabParam;
            var locationParam;
            var eventParam;
            var pointParam;
            var queryParam;
            var diagramParam;
            
            //Query Form
            let conditions = [];
            
            //For drawing custom lines
            var linePoints = [];
            var lineGraphic;
            var userDrawnSketchLength=0;
            
            //Simplified Roadway Diagram
            var rulerY; // Vertical position of the ruler
            var rulerHeight; // Height of the ruler
            var rulerMargin; // Margin from left and right borders
            var rulerLength; // Length of the ruler in miles  
            var rulerWidth;
            var pixelsPerMile;
            var labelY; // Y position for upper labels
            var labelPositions; // X positions for upper labels
            var labelFactor;
            var labelValue;            
            var maxAttributesOnPage=0;
            var numberOfAttributes=0;
            var attributeStartY=210;
            var spacePerAttribute=65;
            var csNBR;
            var beginMPT;  
            var diagramCSBegin;
            var diagramCSEnd;
            var diagramTitle;
            var diagramBeginDFO;
            var diagramEndDFO;   
            var inventoryDiagramLog = [];
            var inventoryDiagramLogAllValues = [];
            var drawMPTLabels = true;
            
            var diagramColors = [
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"]
            ];

            let mainTOCLayers = ["AADT", "Bridges", "Control Sections", "Functional Classification & Urban Areas", "Maintenance Section Boundaries",
                                 "Reference Markers", "Top 100 Congested Roadways", "Tolls", "National Highway System", "Alt Fuels - Electric", "Hurricane Evacuation Routes", "Metropolitan Planning Organizations (MPO)"]

            let displayPopupInfo = [{}]
            
            //Basemap URLs
            //Consider putting these in a standalone table in AGO (then query to use in the planning map).  Would be helpful if these weren't hard coded.
            //Same for Overlays
            var tileLayerTxDOT = "https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap/VectorTileServer";
            var tileLayerLightGray = "https://www.arcgis.com/sharing/rest/content/items/507a9905e7154ce484617c7327ee8bc4/resources/styles/root.json";
            var tileLayerDarkGray = "https://www.arcgis.com/sharing/rest/content/items/4bd376c56f314bc5a36446630db604a6/resources/styles/root.json";
            var tileLayerStreets = "https://basemaps.arcgis.com/arcgis/rest/services/World_Basemap_v2/VectorTileServer";            
            
            require([
              "esri/Map",
              "esri/views/MapView",
              "esri/layers/FeatureLayer",
              "esri/rest/support/Query",
              "esri/PopupTemplate",
              "esri/geometry/Point",
              "esri/geometry/SpatialReference",
              "esri/layers/TileLayer",
              "esri/views/layers/FeatureLayerView",
              "esri/layers/VectorTileLayer",
              "esri/widgets/ScaleBar",
              "esri/widgets/DistanceMeasurement2D",
              "esri/request",
              "esri/layers/GraphicsLayer",
              "esri/Graphic",
              "esri/Basemap",
              "esri/geometry/Polyline",
              "esri/geometry/geometryEngine",
              "esri/geometry/support/webMercatorUtils",
              "esri/symbols/SimpleLineSymbol",
              "esri/layers/OpenStreetMapLayer",
              "esri/widgets/Search",
              "esri/layers/SubtypeGroupLayer",
              "esri/widgets/Legend",
              "esri/layers/WebTileLayer",
              "esri/layers/WMTSLayer",
              "esri/widgets/Print",
              "esri/widgets/Print/PrintViewModel",
              "esri/widgets/Expand"
            ], function(Map,MapView,FeatureLayer,Query,PopupTemplate,Point,SpatialReference,TileLayer,FeatureLayerView,VectorTileLayer,ScaleBar,DistanceMeasurement2D,
                        request,GraphicsLayer,Graphic,Basemap,Polyline,geometryEngine,webMercatorUtils,SimpleLineSymbol, OpenStreetMapLayer, Search, SubtypeGroupLayer, 
                        Legend, WebTileLayer, WMTSLayer, Print, PrintVM, Expand) {
              console.log(GH_TOKEN)
              var map = new Map({
                  //map content added below
              });

              //load toc feature layer

              let tocFeatureLayer = new FeatureLayer({
                url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/SPM_TOC_Layers_Updated/FeatureServer/0"
              })
              
              //load startup function
              const getURLParams = (url) => new URLSearchParams(url)
              startup()

              function startup(){
                //Load map options on startup
                
                loadBaseMaps()
                window.onload = async () => {
                  
                  await loadTOCContent()
                  addSoloLayers()
                  initBasemapOverlayToggle()
                  onViewLoad()
                  readUrlParams()
                  //moveTable()
                  //queryPageBtnDisable()
                }
              }
              //Load map options on startup
              //window.onload = readUrlParams;  
              
              //Drag and Drop---------------------------------------------------
              var dropZone = document.getElementById('viewDiv');
              
              // Add an event listener for the drop zone's drop event
              dropZone.addEventListener('drop', function(event) {
                event.preventDefault();
                var file = event.dataTransfer.files[0];
              
                if (file.type === 'text/csv') {
                  var reader = new FileReader();
                  reader.addEventListener('load', function(event) {
                    var csv = event.target.result;
                    var rows = csv.split('\n');
      
                    rows = rows.filter(function(row) {
                      return row.trim() !== '';
                    });
              
                    var data = rows.map(function(row) {
                      var values = row.match(/(?:[^,"]+|"[^"]*")+/g);
                      return values.map(function(value) {
                        return value.replace(/^"(.*)"$/, '$1');
                      });
                    });
                    handleDropFile(data);
                  });
              
                  reader.readAsText(file);
                } else {
                  alert('Please drop a CSV file');
                }
              });
              
              // Add an event listener for the drop zone's dragover event
              dropZone.addEventListener('dragover', function(event) {
                event.preventDefault();
              });
              
              function handleDropFile(data) {
                for (var i = 1; i < data.length; i++) {
                  getLineworkWithM(data[i][0],data[i][1],data[i][2],data[i][3],data[i][4],data[i][5]);
                }
              }
              
              //data is an array of Route ID, From DFO, To DFO ["IH0035-KG",15,30], rework to loop through records in the file
              function getLineworkWithM(rteID,frmDFO,toDFO,theColor,theWidth,theDescription) {
                var url = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0";
                var paraMeters = "/query?f=json&where=RTE_NM='" + rteID + "'&returnGeometry=true&returnM=true";
							
                request(url+paraMeters).then(function(response) {
                    walkGeom(response,rteID,frmDFO,toDFO,theColor,theWidth,theDescription);
                });                
              }
              
              function walkGeom(theGeom,rteID,theBegin,theEnd,theColor,theWidth,theDescription) {
                // console.log(theGeom);
                var theGeomPart;
                var coordX;
                var coordY;
                var coordM;
                var newLinePoints = [];
                
                for (var a=0; a < theGeom.data.features.length; a++) {
                  theGeomPart = theGeom.data.features[a].geometry.paths; 
                  for (var j = 0; j < theGeomPart[0].length; j++) {
                      coordX = theGeomPart[0][j][0];
                      coordY = theGeomPart[0][j][1];
                      coordM = theGeomPart[0][j][2];
                      if (coordM>=theBegin&&coordM<=theEnd) {
                        newLinePoints.push([a,0,j,coordX,coordY]);                        
                      }
                  }
                }  

                //Loop through the results and split up the array based on any segment breaks
                let result = [];
                let currentArr = [newLinePoints[0]];
                
                for (let i = 1; i < newLinePoints.length; i++) {
                  if (newLinePoints[i][0] !== currentArr[0][0]) {
                    result.push(currentArr);
                    currentArr = [newLinePoints[i]];
                  } else {
                    currentArr.push(newLinePoints[i]);
                  }
                }
                result.push(currentArr); 

                var indexOne;
                var indexTwo;
                var indexThree;
                var segmentArrayLength;
                
                //Loop through the results extend the events and add to the map
                for (var z = 0; z < result.length; z++) {
                  //For the first point on the segment
                  indexOne = result[z][0][0];
                  indexTwo = result[z][0][1];
                  indexThree = result[z][0][2];   
                  
                  if (indexThree>0) {
                    var pointOneX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][0];
                    var pointOneY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][1];
                    var pointTwoX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][0];
                    var pointTwoY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][1]; 
                    var definedLength = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2]-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][2]; //the m difference between vertices
                    var lengthFromFirstPoint = theBegin-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][2];  //event from-beginning vertex m                
                    var newBeginPoint = interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,definedLength,lengthFromFirstPoint);
                    
                    //Add to the beginning of the array
                    //Don't run unless distance is greater than .001
                    if (lengthFromFirstPoint>.001) {
                        result[z].unshift([0,0,0,newBeginPoint[0],newBeginPoint[1]]);                  
                    }
                  }      
                  
                  segmentArrayLength = result[z].length;
                  
                  //For the last point on the segment
                  indexOne = result[z][segmentArrayLength-1][0];
                  indexTwo = result[z][segmentArrayLength-1][1];
                  indexThree = result[z][segmentArrayLength-1][2];
                  
                  if (indexThree<theGeom.data.features[indexOne].geometry.paths[indexTwo].length-1) {
                    var pointOneX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][0];
                    var pointOneY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][1];
                    var pointTwoX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][0];
                    var pointTwoY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][1]; 
                    var definedLength = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][2]-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2]; //the m difference between vertices
                    var lengthBeyondLastPoint = theEnd-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2];  //event from-ending vertex m                
                    var newEndPoint = interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,definedLength,lengthBeyondLastPoint);
                    
                    //Adding to the end of the array
                    //Don't run unless distance is greater than .001
                    if (lengthBeyondLastPoint>.001) {
                      result[z].push([0,0,0,newEndPoint[0],newEndPoint[1]]);
                    }     
                  }
                }
                
                let finalResult = result.map(subArr => subArr.map(innerSubArr => innerSubArr.slice(3)));

                for (var x = 0; x < finalResult.length; x++) {
                  var line = new Polyline({
                    paths: [finalResult[x]],
                    spatialReference: { wkid: 102100 }
                  });
          
                  lineGraphic = new Graphic({
                    attributes: [rteID,theBegin,theEnd,theColor,theWidth,theDescription],
                    geometry: line,
                    symbol: {
                      type: "simple-line",
                      color: theColor,
                      width: theWidth
                    },
                    popupTemplate: new PopupTemplate({
                      title: rteID,
                      content: theDescription
                    })                  
                  });
                  //Add line to map
                  graphicsLayer.add(lineGraphic);
                  
                  // console.log(finalResult[x][0][1]);
                  // console.log(finalResult[x][0][0]);
                  
                  // //Add begin and end points from segment
                  // var inputPoint = new Point({
                  //   x: finalResult[x][0][0],
                  //   y: finalResult[x][0][1],
                  //   spatialReference: new SpatialReference({ wkid: 3857 })
                  // });               
                  
                  // // Create a point graphic with the specified properties
                  // var pointGraphic = new Graphic({
                  //   geometry: inputPoint,
                  //   symbol: {
                  //     type: "simple-marker",
                  //     color: "Green",
                  //     size: 10,
                  //     outline: {
                  //       color: "Black",
                  //       width: "1px"
                  //     }
                  //   },
                  //   popupTemplate: new PopupTemplate({
                  //     title: rteID,
                  //     content: "Begin Point"
                  //   }) 
                  // });
                  
                  // // Add the point graphic to the graphics layer
                  // graphicsLayer.add(pointGraphic);                      
                }
                
                zoomToGraphicExtent();
              }
              
              //Finding the begin/end point of the event
              function interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,totalLength,segmentLength) {
                const ratio = (segmentLength*1609.344) / (totalLength*1609.344);
                
                // Interpolate the Web Mercator coordinates of the point along the line
                const interpolatedMercator = [
                  pointOneX + (ratio * (pointTwoX - pointOneX)),
                  pointOneY + (ratio * (pointTwoY - pointOneY))
                ];                

                var newCoord = [interpolatedMercator[0],interpolatedMercator[1]];
                return newCoord;
              }
              //End drag and drop-----------------------------------------------
              
              //Base map tile layers--------------------------------------------
              async function loadBaseMaps(){
                let returnUrl = await basemapFeatureLayerActiveCheck(tileLayerTxDOT)
                txdotLayer = new VectorTileLayer({
                  url: returnUrl,
                  visible: false,
                  name: "txdot"
                }); 
                //Light Gray Layer
                lightGrayLayer = new VectorTileLayer({
                    url: tileLayerLightGray,
                    visible: false,
                    name: "lightgray"
                });

                //Dark Gray Layer
                darkGrayLayer = new VectorTileLayer({
                    url: tileLayerDarkGray,
                    visible: false,
                    name: "darkgray"                  
                });    

                //ESRI Streets Layer
                streetsLayer = new VectorTileLayer({
                    url: tileLayerStreets,
                    visible: false,
                    name: "esristreets"                  
                });

                let OSMBasemap = new OpenStreetMapLayer({
                  visible: false,
                  name: "osm"
                })

                let texasImagery = new WMTSLayer({
                  url: "https://txgi.tnris.org/login/path/corner-express-popcorn-compact/wmts",
                  serviceMode: "KVP",
                  activeLayer: {
                    id: "texas",
                    tileMatrixSets: ["0to20"],
                    imageFormat: "png"
                  },
                  visible: false,
                  name: "imagery"
                })

                
                map.addMany([txdotLayer,lightGrayLayer, darkGrayLayer, streetsLayer, OSMBasemap, texasImagery]);

                basemapAll = [{name: "txdot", featLayer: txdotLayer}, {name: "lightgray", featLayer: lightGrayLayer}, 
                                  {name: "darkgray", featLayer: darkGrayLayer}, {name: "esristreets", featLayer: streetsLayer},
                                  {name: "osm", featLayer: OSMBasemap}, {name: "imagery", featLayer: texasImagery}]
                return;                    
              }
              //TxDOT Tile Layer
             
              //End basemap tile layers-----------------------------------------
        
              //Add roadway inventory layer
              function addSoloLayers(){
                var roadwayInventoryLayerUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/TxDOT_Roadway_Inventory/FeatureServer/0";
                roadwayInventoryfeatureLayer = new FeatureLayer({
                  url: roadwayInventoryLayerUrl,
                  visible: false,
                  outFields: ["*"],
                  name: "RoadInventory"
                });   
                map.add(roadwayInventoryfeatureLayer);
              }

              
              view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-100, 31.5],
                zoom: 6
              });       
              
              view.ui.remove("attribution");
              
              view.constraints = {
                minZoom: 5,
                maxZoom: 21,
                rotationEnabled: false
              };
              
              // function resize(){
              //   document.querySelector("#left-div").classList.add("invisible");
              //   document.querySelector("#viewDiv").classList.add("mobileViewDiv")
              // }

              // view.watch((["widthBreakpoint", "zoom"]), (breakP) =>{
              //   if(typeof breakP === "string"){
              //       switch(breakP){
              //       case "xsmall":
              //         resize()
              //         break;
              //       case "small":
              //       case "medium":
              //       case "large":
              //       case "xlarge":
              //       default:
              //     }
              //     return
              //   } 
                
              //   displayFeatOnZoom(breakP, "Texas Roadways Unsegmented")
              // })
              //Scale Bar-------------------------------------------------------
              var scaleBar = new ScaleBar({
                view: view,
                unit: "miles"
              });
              
              let searchBar = new Search({
                view: view,
                visible: false,
                allPlaceholder: "Search for TxDOT Item",
                includeDefaultSources: false,
                container: searchBox,
              });

              view.ui.add(searchBar, {
                position: "top-left",
              })

              let legend = new Legend({
                view: view,
                visible: false,
              })

              view.ui.add(legend,{
                position: "bottom-right"
              })

              view.ui.add(scaleBar, {
                position: "bottom-left"
              });
              
              scaleBar.style = "";

              let printer;
              document.getElementById("print").addEventListener("click", ()=>{
                if(!printer){
                  activateToolButton("print")
                  printer = new Print({
                    view: view,
                    printServiceUrl: "https://maps.txdot.gov/createags/rest/services/CustomPrint/GPServer/Export%20Web%20Map",
                    visible: true,
                  }) 

                  view.ui.add(printer, {
                    position: "bottom-right"
                  })
                  return
                }

                if(printer.visible === false){
                  printer.visible = true
                  activateToolButton("print")
                  return
                }

                printer.visible = false
                resetButton("print")
                return
              })

              // let printerExpand = new Expand({
              //   view: view,
              //   content: printer
              // })

              
              // view.ui.add(printerExpand,{
              //   position:"top-right",
              //   index: 0
              // })

              // print.on("submit", (event)=>{
              //   console.log(event.link.url)
              // })
              //End Scale Bar---------------------------------------------------
              
              //Measure---------------------------------------------------------
              let measurementWidget = new DistanceMeasurement2D({
                  view: view
              });
              view.ui.add(measurementWidget, "bottom-right");            
                
              measurementWidget.visible = false;
              
              const measureListener = document.querySelector('#measureButton');
              measureListener.addEventListener('click', (event) => {
                if (measurementWidget.visible == true) {
                    measurementWidget.visible = false;
                    resetButton("measureButton");                    
                } else {
                    measurementWidget.visible = true;
                    resetButton("lrsButton");
                    lrsButtonStatus=false;
                    clearInnerHTML("mapClickResults");                     
                    activateToolButton("measureButton");
                    graphicsLayer.removeAll();                    
                }
              });              
              //End Measure-----------------------------------------------------
              
              //Search-----------------------------------------------------------------------
              searchBar.when((search) => {
                //only toggle whensearchBar.sources are built
                document.getElementById("searchTool").addEventListener("click", (event) =>{
                  if(searchBar.visible === true){
                    searchBar.visible = false
                    resetButton("searchTool")
                    return
                  }

                  searchBar.visible = true
                  activateToolButton("searchTool")
                  return
                })
              })
              //End Search--------------------------------------------------------------------

              //Load Roadway Inventory forms------------------------------------

              const getCurrentQuerySelection = () => document.querySelector(`input[name="featQuery"]:checked`).value


              function disableQuery(){
                let isChecked = document.querySelector(`input[name="featQuery"]:checked`)
                if(!isChecked){
                  for(let i in document.querySelector('#queryTab').childNodes[1]){
                    if(i > 1){
                      document.querySelector('#queryTab').childNodes[1][i].disabled = true
                    }
                    else{
                      
                    }
                  }
                  return true
                }
                return false
              }

              function addEventListener(tabname, isAllDisabled){
                let getItems = document.querySelector(tabname)
                let inputFields = getItems.querySelectorAll(".noDisabled1")
                initValueCheck(inputFields, getItems)
                inputFields.forEach((x,i) =>{
                  if(x.tagName === "SELECT"){
                    selectEventListner(x.id)
                  }
                  else{
                    inputEventListner(x.id)
                  }
                })
              }
              document.getElementById("ri").addEventListener("change", () => document.getElementById("field").disabled = false)

              document.getElementById("bridge").addEventListener("change", () => document.getElementById("field").disabled = false)

              function selectEventListner(id){
                document.getElementById(id).addEventListener("change", (event)=>{
                  if(event.target.value != ""){
                    event.target.nextElementSibling.disabled = false
                    if(event.target.type === "select-multiple"){
                      let classBtn = event.target.nextElementSibling.className.split(" ")
                      document.querySelectorAll(`.${classBtn[1]}`).forEach(x => x.disabled = false)
                    }
                    
                  }
                  else{
                    event.target.nextElementSibling.disabled = true
                    if(event.target.type === "select-multiple"){
                      let classBtn = event.target.nextElementSibling.className.split(" ")
                      document.querySelectorAll(`.${classBtn[1]}`).forEach(x => x.disabled = true)
                    }
                  }
                })
              }

              function inputEventListner(id){
                document.getElementById(id).addEventListener("input", (event)=>{
                  displayErrorMsg(event.target.validity)
                  if(event.target.value != ""){
                    if(event.target.nextElementSibling.tagName === 'BR'){
                      event.target.nextElementSibling.disabled = false
                    }
                    event.target.nextElementSibling.disabled = false
                  }
                  else{
                    event.target.nextElementSibling.disabled = true
                  }
                })
              }

              function toggleQueryBtns(id, status) {
                let btns = document.getElementById(id).getElementsByTagName("button")
                for(let btn in btns){
                  btns[btn].disabled = status
                }
              }

              function initValueCheck(values, tab){
                let a = 0;
                for(let i =0; i < tab.children[0].length; i++){
                  if(tab.children[0][i].value === "" && tab.children[0][i].tagName != "BUTTON"){
                    a++
                  }
                }
                let btns = tab.getElementsByTagName("button")
                
                if(a > 0 ){
                  for(let b in btns){
                    if(btns[b].tagName === "BUTTON"){
                      document.getElementById(btns[b].id).disabled = true
                    }
                    return
                  }
                }
                for(let b in btns){
                  if(btns[b].tagName === "BUTTON"){
                    document.getElementById(btns[b].id).disabled = false;
                  }
                }

              }

              function displayErrorMsg(validity){
                let errorMsg = {"badInput": "Check type required for input", "rangeOverflow": "A number between 1-8 is required", "rangeUnderflow": "A number between 1-8 is required", 
                                "typeMismatch": "An invalid type has been detected. Try again.", "valueMissing":"Value is Missing.", "stepMismatch":"Field requires 3 decimal places."}
                
                for(let k in validity){
                  if(validity[k] === true){
                    document.getElementById("error").textContent = errorMsg[k]
                    return
                  }
                  document.getElementById("error").textContent = ""
                  continue
                }
              }

              function pageBtnDisable(id){
                if(conditions.length === 0){
                  toggleQueryBtns(id, true)
                }
                
                //let btns = document.getElementById(id).getElementsByTagName("button")

                // ["change", "input"].forEach((x) => {
                //   document.getElementById(id).addEventListener(x, (event) => {
                    
                //     if(event.target.tagName === "SELECT"){
                //       let input = document.getElementById(id).getElementsByTagName("input")
                //       for(let i in input){
                //         if(!input[i].value) continue
                //         displayErrorMsg(input[i].validity)
                //         if(input[i].value.length < 1){
                //           toggleQueryBtns(id, true)
                //           continue
                //         }
                //         toggleQueryBtns(id, false)
                //         continue
                //       }   
                //     }
                //     if(event.target.tagName === "INPUT"){
                //       displayErrorMsg(event.target.validity)
                //       let select = document.getElementById(id).getElementsByTagName("select")
                //       console.log(event.target)
                //       for(let i in select){
                //         if(select[i].value|| event.target.value.length < 1){
                //           toggleQueryBtns(id, true)
                //           continue
                //         }
                //         toggleQueryBtns(id, false)
                //         continue
                //       }   
                //     }
                //     // let selectOutput = document.getElementById("outputFields")
                //     // event.target.value.length && selectOutput.value.length ? toggleQueryBtns(id, false) : toggleQueryBtns(id, true)

                //   })
                // })
              }
              
              function onViewLoad(){
                let url = getURLParams(window.location.search)
                let getQueryType = window.location.search ? url.get("queryType") ?? "RoadInventory" : "RoadInventory"
                // for(let q of document.getElementById("querySelectionFilter").input){
                //   console.log(q)
                //   if(q.value === getQueryType){
                //     q.selected = true
                //   }
                // }
                
                let getCurrentFeatLayer = retrieveFeatureLayer(getQueryType)
                view.whenLayerView(getCurrentFeatLayer[0]).then(function(layerView) {
                  featureLayerView = layerView;
                  populateQueryForm(getQueryType);
                });
                if(conditions.length < 1){
                  document.getElementById("outputFields").disabled = true
                  clearConditions()
                }
                for(let z=0; z < document.getElementsByTagName("INPUT").length; z++){
                  if(document.getElementsByTagName("INPUT")[z].type != "radio"){
                    document.getElementsByTagName("INPUT")[z].textContent = ""
                    //document.getElementsByTagName("INPUT")[z].value = ""
                  }
                  
                }
                //document.getElementsByTagName("INPUT")
                return;
              }
              
              //Re-orders array
              function sendItemToFront(theArray,itemsToMove) {
                let copyRdsInventoryArr = [...new Set([...itemsToMove,...theArray])]              
                return copyRdsInventoryArr;
              }

              function setRoadwayQuery(){
                //clear current contents in outputFields first
                var roadwayInventoryFieldsArray = featureLayerView.availableFields;
                let arrToMove = ["RIA_RTE_ID", "FRM_DFO", "TO_DFO", "C_SEC", "BMP", "EMP"]
                let returnRdwyInventoryArr = sendItemToFront(roadwayInventoryFieldsArray,arrToMove)
                return returnRdwyInventoryArr
              }

              function setBridgeQuery(){
                //clear current contents in outputFields first
                return bridgeInventoryFieldsArray
              }

              function selectQuery(event){
                if(document.getElementById("outputFields").textContent.length ){
                  document.getElementById("outputFields").textContent = ""
                  document.getElementById("field").textContent = ""
                  let resetItem = event === "RoadInventory" ? "Bridges" : "RoadInventory"
                  resetFeatureLayer(resetItem)
                  console.log(resetItem)
                  populateQueryForm(event)
                  return
                }
                populateQueryForm(event)
              }

              function typeAhead(){
                ///
                document.getElementById("tableSearch").addEventListener("input", (event)=>{
                  let regex = new RegExp(`${event.target.value}`)

                  console.log(queryTableResults)
                })
                
              }

              async function populateQueryForm(type) {
                //On startup, roadway inventory should display
                //On selection of either option, fields should auto load
                let populateQueryFormPromise = new Promise((res,rej) =>{
                  var fieldSelect = document.getElementById('field');
                  var outputFieldsSelect = document.getElementById('outputFields');

                  //Puts the RIA_RTE_ID, DFO, CS, and MPT columns first
                  let returnRdwyInventoryArr = type === "RoadInventory" ? setRoadwayQuery() : setBridgeQuery() 
                  
                  for (var i = 0; i < returnRdwyInventoryArr.length; i++) {
                    var field = returnRdwyInventoryArr[i];
                    var optionField = document.createElement("option");
                    var optionSelect = document.createElement("option");
                    optionField.text = field.toUpperCase();
                    optionField.value = field;
                    optionSelect.text = field.toUpperCase();
                    optionSelect.value = field;                  
                    outputFieldsSelect.appendChild(optionSelect);
                    fieldSelect.appendChild(optionField);                  
                  }
                  res("complete")
                })

                return await populateQueryFormPromise
                
              }
              //End populate Inventory forms------------------------------------
    
              //LRS Identify----------------------------------------------------
              const lrsListener = document.querySelector('#lrsButton');
              lrsListener.addEventListener('click', (event) => {
                if (lrsButtonStatus == true) {
                    resetButton("lrsButton");
                    lrsButtonStatus = false;
                    clearInnerHTML("mapClickResults");
                    graphicsLayerLRSIdentify.removeAll();
                } else {
                    resetButton("measureButton");
                    measurementWidget.visible = false;                    
                    activateToolButton("lrsButton");
                    lrsButtonStatus = true;
                    clearInnerHTML("mapClickResults");                    
                }                
              });
              
              view.on("click",function(event){
                 if (lrsButtonStatus==true) {
                    graphicsLayerLRSIdentify.removeAll();
                    let point = view.toMap({x: event.x, y: event.y});
                    var url = "https://lrs-ext.us-e1.cloudhub.io/api/elrs1?Lat="+point.latitude.toFixed(8)+"&Lon="+point.longitude.toFixed(8);
                    
                    //add graphic to map
                    var pointGraphic = new Graphic({
                          geometry: point,
                          symbol: {
                            type: "simple-marker",
                            color: "red",
                            size: "10px"
                          }
                    });      
                    
                    graphicsLayerLRSIdentify.add(pointGraphic);
                    document.getElementById("mapClickResults").innerHTML = "Calculating LRMs...";
                    
                    //Populate LRS Readout
                    request(url).then(function(response) {
                        processLRSResponse(response);
                    });                    
                 } 
                 //get overlays that are visible
                 let visibleLayer = []
                 let getVisibleLayers = itemArr.filter(x => x.visible === 1)
                 getVisibleLayers.forEach(y => visibleLayer.push(y.name))
                 if (event.button === 2) {
                    let point = view.toMap({x: event.x, y: event.y});
                    var mapForURL = "";
                    if (txdotLayer.visible==true) {
                      mapForURL = "txdot";
                    } else if (lightGrayLayer.visible==true) {
                      mapForURL = "lightgray";
                    } else if (darkGrayLayer.visible==true) {
                      mapForURL = "darkgray";
                    } else {
                      mapForURL = "esristreets";
                    }
                    
                    let overlayUrl = visibleLayer.length ? `overlays=${visibleLayer.toString()}&map=${mapForURL}&location=${point.latitude.toFixed(8)},${point.longitude.toFixed(8)},${view.zoom}` : `map=${mapForURL}&location=${point.latitude.toFixed(8)},${point.longitude.toFixed(8)},${view.zoom}`
                    let rightClickURL = `${window.location.href}?${overlayUrl}`
                    //var rightClickURL = "https://www.txdot.gov/apps/statewide_mapping/StatewidePlanningMap.html?map="+mapForURL+"&location="+point.latitude.toFixed(8)+","+point.longitude.toFixed(8)+","+view.zoom;
                    var latLongOnly = point.latitude.toFixed(8)+","+point.longitude.toFixed(8);
                    
                    queryToUrl(rightClickURL)
                                    
                 }
              });
              
              function processLRSResponse(theResponse) {
                var numbers = theResponse.data;
                var lowestNumber = numbers[0].distance;
                var lowestIndex = 0;
                
                for (var i = 1; i < numbers.length; i++) {
                  if (numbers[i] < lowestNumber) {
                    lowestNumber = numbers[i];
                    lowestIndex = i;
                  }
                }     
                
                var lrsReadoutData=[];
                lrsReadoutData.push(["Conrol Section",theResponse.data[lowestIndex].CTRL_SECT_LN_NBR]);
                lrsReadoutData.push(["Mile Point",theResponse.data[lowestIndex].CTRL_SECT_MPT]); 
                lrsReadoutData.push(["Reference Marker",theResponse.data[lowestIndex].RMRKR_PNT_NBR]);
                lrsReadoutData.push(["Displacement",theResponse.data[lowestIndex].RMRKR_DISPLACEMENT]);                 
                lrsReadoutData.push(["Route",theResponse.data[lowestIndex].RTE_DEFN_LN_NM]);
                lrsReadoutData.push(["Distance From Origin",theResponse.data[lowestIndex].RTE_DFO]);
                lrsReadoutData.push(["Latitude",theResponse.data[lowestIndex].LAT.toFixed(6)]);
                lrsReadoutData.push(["Longitude",theResponse.data[lowestIndex].LON.toFixed(6)]);
                
                if (document.getElementById("diagramTab").style.display == "block"||document.getElementById("eventTab").style.display == "block") {
                  document.getElementById("inpSRDRouteID").value = theResponse.data[lowestIndex].RTE_DEFN_LN_NM;
		              document.getElementById("eventRoute").value = theResponse.data[lowestIndex].RTE_DEFN_LN_NM; 
                  var startingDFO = Number(theResponse.data[lowestIndex].RTE_DFO.toFixed(3));
                 if ((startingDFO-1)<0) {
                    document.getElementById("inpSRDFromDFO").value = startingDFO;
                    document.getElementById("inpSRDToDFO").value = startingDFO+1;
                    document.getElementById("eventBeginDFO").value = startingDFO;
                    document.getElementById("eventEndDFO").value = startingDFO+1;
                  } else {
                    document.getElementById("inpSRDFromDFO").value = startingDFO-1;
                    document.getElementById("inpSRDToDFO").value = startingDFO+1; 
                    document.getElementById("eventBeginDFO").value = startingDFO-1;
                    document.getElementById("eventEndDFO").value = startingDFO+1;                 
                  }
                  
                  ["#diagramTab","#eventTab"].forEach((x) =>{
                      let getField = document.querySelectorAll(x)
                      console.log(getField[0])
                      for(let a=0; a < getField[0].children[0].length; a++){
                        if(getField[0].children[0][a].tagName != "BUTTON" && getField[0].children[0][a].value.length){
                            getField[0].children[0][a].disabled = false
                            getField[0].children[0][a].nextElementSibling.disabled = false
                            
                        }
                      }
                  })
                 
                }
               
                var table = document.createElement("table");
                table.setAttribute("id", "lrsOutputTable");
                
                for (i = 0; i < lrsReadoutData.length; i++) {
                  var row = document.createElement("tr");
                  for (var j = 0; j < lrsReadoutData[i].length; j++) {
                    var cell = document.createElement("td");
                    var cellText = document.createTextNode(lrsReadoutData[i][j]);
                    cell.appendChild(cellText);
                    row.appendChild(cell);
                  }
                  table.appendChild(row);
                }
                
                clearInnerHTML("mapClickResults");
                document.getElementById("mapClickResults").appendChild(table);
                
                //Create element for exporting LRS results
                var newSpan = document.createElement("span");
                newSpan.setAttribute("id", "exportSpan");                
                newSpan.innerHTML = "Export Readout";
              
                newSpan.addEventListener("click", function() {
                  exportTableToCSV("#lrsOutputTable");
                });
                
                document.getElementById("mapClickResults").appendChild(newSpan); 
                toggleQueryBtns("diagramTab", false)
              }
              //End LRS Identify------------------------------------------------
            
              //Lat Long Coordinates on mouse move------------------------------
              view.on('pointer-move',function(event){
                  let point = view.toMap({x: event.x, y: event.y});
                  document.getElementById("marginal").innerHTML = "Level: " + view.zoom + ", " + point.latitude.toFixed(6) + ", " + point.longitude.toFixed(6);
              });
              //End Lat Long Coordinates----------------------------------------
              
              //Listeners-------------------------------------------------------
              //Jump to Google listener
              const jumpGoogleListener = document.querySelector('#googleMaps');
              jumpGoogleListener.addEventListener('click', (event) => {
                openGoogleMaps();
              }); 

              document.getElementById("legend").addEventListener("click", (event) => {
                if(legend.visible === true){
                  legend.visible = false
                  resetButton("legend")
                  return
                }

                activateToolButton("legend")
                legend.visible = true
                return
              })

              function toggleLayer(id){
                if(basemapAll.find(x => x.name === id)) return toggleBaseMap(id)
                let returnId = itemArr.find(it => it.name === id)
                if(!returnId) return removeOverlay(id)

                let layerId = retrieveFeatureLayer(returnId.name)
                layerId.forEach(x => x.visible === true ? setInvisible(x, returnId, id) : setIsVisible(x, returnId, id))

                let isVisible = itemArr.find(x => x.visible)
                isVisible ? resetBaseMapItem("CLEAR") : activateBaseMapItem("CLEAR")
              }

              function retrieveFeatureLayer(name){
                let layerId = map.layers.items.filter((lyrId) => {
                  if(lyrId.name === name){
                    return lyrId
                  }
                })
                return layerId
              }

              function setInvisible(layerId, returnId, id){
                layerId.visible = false;
                resetBaseMapItem(id)
                returnId.visible = 0
                //legend.visible = false
                resetButton("legend")
              }

              function setIsVisible(layerId, returnId, id){
                layerId.visible = true;
                activateBaseMapItem(id)
                returnId.visible = 1
                //legend.visible = true
                activateButton("legend")
              }

              function initBasemapOverlayToggle(){
                document.getElementById("tocMaps").addEventListener("click", (event)=>{
                  if(event.target.id === "CLEAR") return clearOverlay(event.target.id)
                  if(event.target.id === "layerSearch") return
                  return toggleLayer(event.target.id)
                })
              }

              function toggleBaseMap(idName){
                resetAllBaseMapItems();
                activateBaseMapItem(`${idName}`);
                let basemap = basemapAll.find(x => x.name === idName)
                basemap.featLayer.visible = true
                return
              }

              function clearOverlay(id){
                let overlayVisible = itemArr.filter(x => x.visible === 1) //set text to black

                overlayVisible.forEach(x => toggleLayer(x.name))
              }

              //TxDOT map listener
              // const lstTxDOTListener = document.querySelector('#lstTxDOT');
              
              // lstTxDOTListener.addEventListener('click', (event) => {
              //   console.log(event)
              //   resetAllBaseMapItems();
              //   activateBaseMapItem("lstTxDOT");
              //   txdotLayer.visible=true;
              // }); 
              
              // //Light gray map listener
              // const lstLightGrayListener = document.querySelector('#lstLightGray');
              // lstLightGrayListener.addEventListener('click', (event) => {
              //   resetAllBaseMapItems();
              //   activateBaseMapItem("lstLightGray");
              //   lightGrayLayer.visible=true;
              // });   
              
              // //Dark gray map listener
              // const lstDarkGrayListener = document.querySelector('#lstDarkGray');
              // lstDarkGrayListener.addEventListener('click', (event) => {
              //   resetAllBaseMapItems();
              //   activateBaseMapItem("lstDarkGray");
              //   darkGrayLayer.visible=true;
              // });    
              
              // //ESRI Streets map listener
              // const lstESRIListener = document.querySelector('#lstESRI');
              // lstESRIListener.addEventListener('click', (event) => {
              //   resetAllBaseMapItems();
              //   activateBaseMapItem("lstESRI");
              //   streetsLayer.visible=true;
              // });               
              
              // //OSM map listener
              // const osmMapListener = document.querySelector('#lstOSM')
              // osmMapListener.addEventListener("click", (event)=>{
              //   resetAllBaseMapItems();
              //   activateBaseMapItem("lstOSM");
              //   streetsLayer.visible=true;
              // })
              //Clear and Reset Map Listener
              const resetListener = document.querySelector('#resetMap');
              resetListener.addEventListener('click', (event) => {
                clearAndResetMap();
              }); 
              
              //Maps tab listener
              const baseMapListener = document.querySelector('#baseMaps');
              baseMapListener.addEventListener('click', (event) => {
                resetAllTabs();
                activateButton("baseMaps");
                document.getElementById("mapTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"
              }); 
              
              //Query tab listener
              const queryListener = document.querySelector('#dataQuery');
              queryListener.addEventListener('click', (event) => {
                resetAllTabs();
                let isAllDisabled = disableQuery()
                activateButton("dataQuery");
                pageBtnDisable("queryTab")
                addEventListener("#queryTab", isAllDisabled)
                document.getElementById("queryTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"               
              });   
              
              //Roadway diagram listener
              const roadwayDiagramListener = document.querySelector('#roadwayDiagram');
              roadwayDiagramListener.addEventListener('click', (event) => {
                resetAllTabs();
                console.log(event)
                let isAllDisabled = disableQuery()
                activateButton("roadwayDiagram");
                pageBtnDisable("eventTab");
                addEventListener("#diagramTab", isAllDisabled)
                document.getElementById("diagramTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"           
              });    
              
              //Event tab listener
              const eventTabListener = document.querySelector('#eventForm');
              eventTabListener.addEventListener('click', (event) => {
                resetAllTabs();
                let isAllDisabled = disableQuery()
                activateButton("eventForm");
                pageBtnDisable("eventTab")
                addEventListener("#eventTab", isAllDisabled)
                document.getElementById("eventTab").style.display = "block";       
                document.getElementById("viewDiv").style.cursor = "default"        
              });               
              
              //Graphic sketch listener
              const graphicSketchListener = document.querySelector('#graphicSketch');
              graphicSketchListener.addEventListener('click', (event) => {
                resetAllTabs();
                activateButton("graphicSketch");
                document.getElementById("sketchTab").style.display = "block";
                createServiceDown("Click to draw line", "#204e70")
                setTimeout(()=>{
                  document.getElementById("serviceDownDiv").remove()
                },2000)        
              }); 
              
              //Check LRM Inputs listener
              const lrmInputsListener = document.querySelector('#btnUpdateLRM');
              lrmInputsListener.addEventListener('click', (event) => {
                checkLRMInputs();
                document.querySelectorAll(".srdBtn").forEach(y => y.disabled = false)
              })
              
              //Add Inventory Attribute listener
              const addInventoryListener = document.querySelector('#btnInventoryUpdateLRM');
              addInventoryListener.addEventListener('click', (event) => {
                addInventoryAttribute(document.getElementById("riAttributes").value.split(","));              
              });  
              
              //Export PNG listener
              const exportPNGListener = document.querySelector('#btnExportPNG');
              exportPNGListener.addEventListener('click', (event) => {
                exportPNG();              
              }); 
              
              //Export JPEG listener
              const exportJPEGListener = document.querySelector('#btnExportJPEG');
              exportJPEGListener.addEventListener('click', (event) => {
                exportJPEG();              
              });        
              
              //Toggle diagram view listener
              const toggleDiagramListener = document.querySelector('#btnToggleDiagramView');
              toggleDiagramListener.addEventListener('click', (event) => {
                toggleVisibility("parentCanvas"); 
                var buttonToggleDiagram = document.getElementById("parentCanvas");
                var buttonText = document.getElementById("btnToggleDiagramView");
                if (buttonToggleDiagram.style.display === "none") {
                  buttonText.textContent = 'Show Diagram';
                } else {
                  buttonText.textContent = 'Hide Diagram';
                }                
              });       
              
              //Toggle diagram clear listener
              const toggleClearnDiagramListener = document.querySelector('#btnClearDiagramView');
              toggleClearnDiagramListener.addEventListener('click', (event) => {
                //toggleVisibility("parentCanvas"); 
                var buttonToggleDiagram = document.getElementById("parentCanvas");
                var buttonText = document.getElementById("btnToggleDiagramView");
                buttonToggleDiagram.style.display = "none"
                // if (buttonToggleDiagram.style.display === "none") {
                //   buttonText.textContent = 'Show Diagram';
                // } else {
                //   buttonText.textContent = 'Hide Diagram';
                // }   
                
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];
                clearDrawings();
                graphicsLayer.removeAll();
                document.getElementById("inpSRDRouteID").value="";
                document.getElementById("inpSRDFromDFO").value="";
                document.getElementById("inpSRDToDFO").value="";                
              });              
              
              
              //Diagram URL listener
              const diagramURLListener = document.querySelector('#btnDiagramGenerateURL');
              diagramURLListener.addEventListener('click', (event) => {
                exportDiagramToURL();
              });  

              //Add condition listener
              const addConditionListener = document.querySelector('#btnAddCondition');
              addConditionListener.addEventListener('click', (event) => {
                addCondition();              
              });          
              
              //Clear condition listener
              const clearConditionListener = document.querySelector('#btnClearConditions');
              clearConditionListener.addEventListener('click', (event) => {
                clearConditions();              
              });  
              
              
              //Run Query listener
              const runQueryListener = document.querySelector('#btnRunQuery');
              runQueryListener.addEventListener('click', (event) => {
                console.log(document.querySelector(`input[name="featQuery"]:checked`))
                let getQueryFeatLayer = retrieveFeatureLayer(document.querySelector(`input[name="featQuery"]:checked`).value)
                console.log(getQueryFeatLayer)
                setLayerDefinitionExpression(getQueryFeatLayer[0]);  
              });    
              
              //Query URL listener
              const queryURLListener = document.querySelector('#btnQueryGenerateURL');
              queryURLListener.addEventListener('click', (event) => {
                exportQueryToURL();
                return
              });                
              
              //Export CSV listener
              const exportCSVListener = document.querySelector('#btnExportToCSV');
              exportCSVListener.addEventListener('click', (event) => {
                exportTableToCSV("#queryResultTable"); 
              });         
              
              //Toggle table view listener
              const toggleTableListener = document.querySelector('#btnToggleTableView');
              toggleTableListener.addEventListener('click', (event) => {
                toggleVisibility("results");           
                var buttonToggleTable = document.getElementById("results");
                var buttonText = document.getElementById("btnToggleTableView");
                if (buttonToggleTable.style.display==="none") {
                  buttonText.textContent = 'Show Table';
                } else {
                  buttonText.textContent = 'Hide Table';
                }                   
              });                
              
              //Calculate Sketch Cost listener
              const sketchCostListener = document.querySelector('#btnCalcCost');
              sketchCostListener.addEventListener('click', (event) => {
                deCalculateCost(); 
              });    
              
              //Clear Sketch
              const sketchClearListener = document.querySelector('#btnClearProject');
              sketchClearListener.addEventListener('click', (event) => {
                userDrawnSketchLength=0;
                graphicsLayer.removeAll();
                linePoints.length = 0;
                document.getElementById("deCostResult").innerHTML = "";
              });                
              
              //Add Event Button
              const addEventButtonListener = document.querySelector('#btnEventMap');
              addEventButtonListener.addEventListener('click', (event) => {
                document.getElementById("btnRemoveLast").disabled = false
                document.getElementById("btnRemoveAll").disabled = false
                document.getElementById("btnExportToKML").disabled = false
                document.getElementById("btnGenerateURL").disabled = false
                //Clearing the LRS identify tools if they area activated
                if (lrsButtonStatus==true) {
                  resetLRSIdentify();                  
                }
                
                // graphicsLayer.removeAll();
                var eventRoute = document.getElementById("eventRoute").value;
                var eventBeginDFO = document.getElementById("eventBeginDFO").value;
                var eventEndDFO = document.getElementById("eventEndDFO").value;
                var eventColors = document.getElementById("eventColors").value;
                var eventWidth = document.getElementById("eventWidth").value;
                var eventDescription = document.getElementById("eventDescription").value;                
                getLineworkWithM(eventRoute,eventBeginDFO,eventEndDFO,eventColors,eventWidth,eventDescription);
              });           
              
              //Export Events to KML
              const exportEventsListener = document.querySelector('#btnExportToKML');
              exportEventsListener.addEventListener('click', (event) => {
                exportKML();
              }); 
              
              //Remove last event
              const removeLastEventsListener = document.querySelector('#btnRemoveLast');
              removeLastEventsListener.addEventListener('click', (event) => {
                var graphics = graphicsLayer.graphics.items;
                if (graphics.length > 0) {
                  var lastGraphic = graphics[graphics.length - 1];
                  graphicsLayer.remove(lastGraphic);
                }
              });                
              
              //Remove all events
              const removeAllEventsListener = document.querySelector('#btnRemoveAll');
              removeAllEventsListener.addEventListener('click', (event) => {
                document.getElementById("eventRoute").value = "";
                document.getElementById("eventBeginDFO").value = "";
                document.getElementById("eventEndDFO").value = "";
                document.getElementById("eventColors").value = "";
                document.getElementById("eventWidth").value = "";
                document.getElementById("eventDescription").value = "";
                document.querySelectorAll(".")
                graphicsLayer.removeAll();
              });         
              
              //Generate URL
              const generateURLEventsListener = document.querySelector('#btnGenerateURL');
              generateURLEventsListener.addEventListener('click', (event) => {
                exportGraphicsToURL();
              });    
              
              //Close modal box
              // const exportCloseListener = document.querySelector('#spnClose');
              // exportCloseListener.addEventListener('click', (event) => {
              //   closeModal();
              // }); 
              
              document.getElementById("querySelectionFilter").addEventListener("change", (event) =>{
                console.log(event)
                selectQuery(event.target.value)
              })

              document.querySelector(".hamburgler").addEventListener("click", ()=>{
                if(document.getElementById("left-div").style.display === "block"){
                  document.getElementById("left-div").style.display = "none"
                  return 
                }
                document.getElementById("left-div").style.display = "block"
                viewTabletInteraction()
                return
              })

              function viewTabletInteraction(){
                view.on("pointer-down",() =>{
                  document.getElementById("left-div").style.display = "none"
                })
              }
              
              //End listeners---------------------------------------------------
              
              //Control buttons and tabs----------------------------------------
              function resetAllTabs() {
                resetButton("baseMaps");
                resetButton("dataQuery");                
                resetButton("roadwayDiagram");
                resetButton("eventForm");
                resetButton("graphicSketch");
                document.getElementById("mapTab").style.display = "none";
                document.getElementById("queryTab").style.display = "none";
                document.getElementById("diagramTab").style.display = "none"; 
                document.getElementById("eventTab").style.display = "none";                
                document.getElementById("sketchTab").style.display = "none";
                document.getElementById("results").style.display = "none";
                document.getElementById("parentCanvas").style.display = "none";
                numberOfAttributes=0;
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];                 
                roadwayInventoryfeatureLayer.visible = false;
                userDrawnSketchLength=0;
                graphicsLayer.removeAll();
                resetLRSIdentify();
                linePoints.length = 0;
                document.getElementById("deCostResult").innerHTML = "";                
              }
              
              function resetAllTools() {
                resetButton("measureButton");
                resetButton("lrsButton"); 
              }      
              
              function resetQueryTool(){

              }
              function clearAndResetMap() {
                setZoomAndLocation([31.5,-100,6]);
                
                //Reset Diagram
                document.getElementById("parentCanvas").style.display = "none";
                numberOfAttributes=0;    
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];                
                
                //Reset Table
                document.getElementById("results").style.display = "none";                
                  
                //reset buttons and div
                clearInnerHTML("mapClickResults");
                resetAllTools();
                measurementWidget.visible = false;
                graphicsLayer.removeAll();
                graphicsLayerLRSIdentify.removeAll();                
              }       
              
              function resetAllBaseMapItems() {
                basemapAll.forEach((x) => {
                  resetBaseMapItem(x.name)
                  x.featLayer.visible = false
                })
                return
              }               
              
              function resetButton(theElement) {
                document.getElementById(theElement).style.backgroundColor = "#f8f8f8";  //was #f1f1f1
                document.getElementById(theElement).style.color = "black";
                document.getElementById(theElement).style.textDecoration = "";
                return
              }              
              
              function activateButton(theElement) {
                document.getElementById(theElement).style.backgroundColor = "#f8f8f8";
                document.getElementById(theElement).style.color = "#204e70";  
                document.getElementById(theElement).style.textDecoration = "underline";
                document.getElementById(theElement).style.textUnderlinePosition = "under";
                document.getElementById(theElement).style.textDecorationThickness = "1.5px";           
                return
              }

              function activateToolButton(theElement){
                document.getElementById(theElement).style.backgroundColor = "#204e70";
                document.getElementById(theElement).style.color = "white";  
                return
              }
              
              function resetBaseMapItem(theElement) {
                document.getElementById(theElement).style.color = "black";
                document.getElementById(theElement).style.fontWeight = "normal";
                document.getElementById(theElement).style.borderLeft = ""
                document.getElementById(theElement).style.paddingLeft = "1rem"
                document.getElementById(theElement).style.backgroundColor = ""
                return
              }
              
              function activateBaseMapItem(theElement) {
                document.getElementById(theElement).style.borderLeft = "6px solid #14375A"
                document.getElementById(theElement).style.paddingLeft = ".6rem"
                document.getElementById(theElement).style.backgroundColor = "rgba(20,55,90,.2)"
                return
                // document.getElementById(theElement).style.color = "red";
                // document.getElementById(theElement).style.fontWeight = "bold";
              }
              
              function clearInnerHTML(theElement) {
                document.getElementById(theElement).innerHTML = "";
                return
              }
              //End buttons and tabs--------------------------------------------
              
              //Jump to Google Maps---------------------------------------------
              function openGoogleMaps() {
                var ctr = view.center;
                var lat = ctr.latitude;
                var lon = ctr.longitude;
                var level = view.zoom + 1;
                window.open("https://www.google.com/maps/@"+lat+","+lon+","+level+"z");
              }      
              //End Google Maps-------------------------------------------------
              
              //Create csv export, table id must have the "#"-------------------
              function exportTableToCSV(theTable) {
                  const table = document.querySelector(theTable);
                  if (!table) {
                      alert('There is no table to export.');
                      return;
                  }
              
                  const rows = Array.from(table.rows);
                  const csv = [];
              
                  rows.forEach(row => {
                      const rowData = [];
                      Array.from(row.cells).forEach(cell => rowData.push(`"${cell.textContent.replace(/"/g, '""')}"`));
                      csv.push(rowData.join(','));
                  });
              
                  downloadCSV(csv.join('\n'), 'table_export.csv');
              }
              //End CSV Export--------------------------------------------------
              
              //Execute the csv download----------------------------------------
              function downloadCSV(csv, filename) {
                  const csvFile = new Blob([csv], { type: 'text/csv' });
                  const downloadLink = document.createElement('a');
              
                  downloadLink.download = filename;
                  downloadLink.href = URL.createObjectURL(csvFile);
                  downloadLink.style.display = 'none';
              
                  document.body.appendChild(downloadLink);
                  downloadLink.click();
                  document.body.removeChild(downloadLink);
              }         
              //End download CSV------------------------------------------------
              
              //Read parameters from the URL------------------------------------
              function defaultbasemap(){
                activateBaseMapItem("lightgray")
                lightGrayLayer.visible = true
                return
              }
              
              //Example: http://example.com/?map=txdot&overlay=AADT&tab=maps&location=31.123,-97.123,10&event=IH0035-KG,15,30,Red,6,Expand to 6 lanes
              function readUrlParams() {
                //Graphics Layer User Lines and Points
                graphicsLayer = new GraphicsLayer();
                map.add(graphicsLayer);               
                
                //Graphics Layer LRS Identify
                graphicsLayerLRSIdentify = new GraphicsLayer();
                map.add(graphicsLayerLRSIdentify);                 
                
                let url = window.location.search
                if(!url.length){
                  //may need to replace
                  resetAllBaseMapItems()
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";
                  defaultbasemap()
                  return
                }

                urlParams = getURLParams(url);
                basemapParam = urlParams.get("map") ?? "lightgray";
                overlayParam = urlParams.get("overlays");
                tabParam = urlParams.get("tab");
                locationParam = urlParams.get("location");
                eventParam = urlParams.get("event");
                pointParam = urlParams.get("point");
                queryParam = urlParams.get("query");
                diagramParam = urlParams.get("diagram");
                let queryType = urlParams.get("queryType")

                if(overlayParam){
                  let splitOverlay = overlayParam.split(",")
                  splitOverlay.forEach((urlOverlay) => {
                    if(!mainTOCLayers.includes(urlOverlay)){
                      appendChildToOverlayList(urlOverlay, "FeatureLayer", false)
                    }
                    
                    let layerId = retrieveFeatureLayer(urlOverlay)
                    let returnId = itemArr.find(overlay => overlay.name === urlOverlay)
                    layerId.visible = true
                    layerId.forEach(featLayer => setIsVisible(featLayer, returnId, urlOverlay))
                    resetBaseMapItem("CLEAR")
                  })
                  
                }

                if(basemapParam){
                  resetAllBaseMapItems()
                  basemapAll.find(x => x.name === basemapParam).featLayer.visible = true
                  activateBaseMapItem(basemapParam)
                }
                
            
                //Set map zoom and location if provided
                if (locationParam) {
                  setZoomAndLocation(locationParam.split(","));
                }
                
                //Add the event if provided
                if (eventParam) {
                  var eventParam = eventParam.replace(/%23/g, "#");
                  const eventArray = eventParam.split('|');
                  // Output the individual arrays
                  for (let i = 0; i < eventArray.length; i++) {
                    const individualArray = eventArray[i].split(',');
                    getLineworkWithM(individualArray[0],individualArray[1],individualArray[2],individualArray[3],individualArray[4],individualArray[5]);
                  }                  
                }
                
                //Add the event if provided
                if (pointParam) {
                  const pointArray = pointParam.split('|');
                  // Output the individual arrays
                  for (let i = 0; i < pointArray.length; i++) {
                    const individualArray = pointArray[i].split(',');
                    mapThePoint(individualArray[0],individualArray[1],individualArray[2],individualArray[3],individualArray[4]);
                  }                  
                }       
                
                if (queryParam) {
                  document.getElementById('conditions').innerHTML = "";
                  const queryArray = queryParam.split('|');
                  const queryFields = queryArray[0].split(',');
                  const queryConditions = queryArray[1].split(' AND ');
                  var operators = ['=', '<', '>', '!=', '<=', '>='];                  
                  for (var i = 0; i < queryConditions.length; i++) {
                    var text = queryConditions[i];
                    var foundOperator = operators.find(function(operatorVal) {
                      return text.includes(operatorVal);
                    });  
                    
                    var arrayConditionsParts = [];
                    if (foundOperator) {
                      arrayConditionsParts = text.split(foundOperator);
                      arrayConditionsParts.splice(1, 0, foundOperator);
                      var field = arrayConditionsParts[0];
                      var operator = arrayConditionsParts[1];
                      var value = arrayConditionsParts[2];
                      conditions.push({field,operator,value});
                      
                      //Add to the display
                      const li = document.createElement('li');
                      li.textContent = `${field} ${operator} ${value}`;
                      document.getElementById('conditions').appendChild(li); 
                    }                    
                  }
                  
                  let returnFeatureLayer = retrieveFeatureLayer(queryType)
                  console.log(returnFeatureLayer)
                  let querySelection = document.getElementById("querySelectionFilter").children.namedItem(queryType)
                  querySelection.selected

                  view.whenLayerView(returnFeatureLayer[0]).then(function(layerView) {
                      var selectElement = document.getElementById("outputFields");
                      for (var i = 0; i < selectElement.options.length; i++) {
                        var option = selectElement.options[i];
                        if (queryFields.includes(option.value)) {
                          option.selected = true;
                        }
                      }
                      setLayerDefinitionExpression(returnFeatureLayer[0]);
                  });                   
                }
                
                if (diagramParam) {
                  const diagramFullArray = diagramParam.split('|');
                  const diagramInputs = diagramFullArray[0].split(',');
                  document.getElementById("inpSRDRouteID").value = diagramInputs[0];
                  document.getElementById("inpSRDFromDFO").value = diagramInputs[1];
                  document.getElementById("inpSRDToDFO").value = diagramInputs[2];
                  
                  //Get specifics for each attribute in the diagram
                  const diagramInventoryInputs = diagramFullArray[1].split(',');
                  const selectElement = document.getElementById("riAttributes");
                  const selectOptions = selectElement.options;
                  
                  for (let i = 0; i < selectOptions.length; i++) {
                    const optionValue = selectOptions[i].value;
                    const optionValuesArray = optionValue.split(",");
                    const lastValue = optionValuesArray[optionValuesArray.length - 1];
                  
                    if (diagramInventoryInputs.includes(lastValue)) {
                      inventoryDiagramLogAllValues.push(optionValuesArray);
                    }
                  }
                  
                  //Start the build diagram process
                  checkLRMInputs();                  
                }

                //Activate tab if provided
                if (tabParam=="maps") {
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";
                } else if (tabParam=="query") {
                  activateButton("dataQuery");
                  document.getElementById("queryTab").style.display = "block";                  
                } else if (tabParam=="event") {
                  activateButton("eventForm");
                  document.getElementById("eventTab").style.display = "block";                  
                } else if (tabParam=="diagram") {
                  activateButton("roadwayDiagram");
                  document.getElementById("diagramTab").style.display = "block"; 
                } else if (tabParam=="sketch") {
                  activateButton("graphicSketch");
                  document.getElementById("sketchTab").style.display = "block";                  
                } else {
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";                  
                }
                return
              }      
              //End URL parameters----------------------------------------------
              
              //Draw map points-------------------------------------------------
              function mapThePoint(theLat,theLong,theColor,theSize,theDescription) {
                var inputPoint = new Point({
                  latitude: theLat,
                  longitude: theLong
                });               
                
                //Convert the Point to Web Mercator spatial reference
                var webMercatorPoint = webMercatorUtils.geographicToWebMercator(inputPoint);
                
                // Create a point graphic with the specified properties
                var pointGraphic = new Graphic({
                  geometry: webMercatorPoint,
                  symbol: {
                    type: "simple-marker",
                    color: theColor,
                    size: theSize,
                    outline: {
                      color: theColor,
                      width: "1px"
                    }
                  },
                  popupTemplate: new PopupTemplate({
                    title: theLat + "," + theLong,
                    content: theDescription
                  }) 
                });
                
                // Add the point graphic to the graphics layer
                graphicsLayer.add(pointGraphic);                
              }
              //End draw points-------------------------------------------------

              //Set map zoom (30,-100,10)---------------------------------------
              function setZoomAndLocation(theLocation) {
                  var point = new Point({
                    x: theLocation[1],
                    y: theLocation[0],
                    spatialReference: new SpatialReference({
                      wkid: 4326
                    })
                  });
                  view.center = point;
                  view.zoom = theLocation[2];                 
              }
              //End set map zoom------------------------------------------------
              
              //Remove startup message in the conditions element
              function removeStartUpCondition() {
                  var ulElement = document.getElementById('conditions');
                  var firstLiElement = ulElement.querySelector('li:first-child');
                  if (firstLiElement && firstLiElement.textContent === 'Conditions listed here') {
                    ulElement.removeChild(firstLiElement);
                  }                  
              }
              
              //Add startup message to conditions element
              function addStartUpCondition() {
                  const li = document.createElement('li');
                  li.textContent = "Conditions listed here";
                  document.getElementById('conditions').appendChild(li); 
                  document.getElementById("outputFields").disabled = true
                  // let btns = document.querySelectorAll(".tableBtn")
                  // for(let i in btns){
                  //   btns[i].disabled = true;
                  // }
              }

              function resetFeatureLayer(roadId){
                let featLayer = retrieveFeatureLayer(roadId)
                featLayer[0].visible = false
                featLayer[0].definitionExpression = ""
                clearConditions()
              }

              function queryResponseUI(text, type, height, width){
                let getTemplate = document.getElementById("queryTemplate")
                let templateClone = getTemplate.content.cloneNode(true)
                let div = templateClone.querySelectorAll("div")
                
                //div[0].style.height = "50%"
                //div[0].style.width = "fit-content"
                let innerModal = document.createElement("div")
                let h2 = document.createElement("h2")
                let textArea = document.createElement("div")
                innerModal.classList.add("overlay")
                let p = document.createElement("p")
                p.id = "queryMessagePara"
                textArea.id = "previewUrl"
                h2.id = "modalHeader"

                
                textArea.textContent = text.url
                textArea.disabled = true
                text.url ? textArea.style.display = "block" : textArea.style.display = "none"

                h2.textContent = text.header
                p.innerHTML = text.para
                div[0].appendChild(h2)
                div[0].appendChild(p)
                div[0].appendChild(textArea)
                
                if(type === "button" || type === null){
                  let btn = document.createElement("button")
                  btn.id = "queryMessageBtn"
                  btn.className = "spmMainBtn"
                  btn.textContent = "CLOSE"
                  btn.onclick = () => {
                    removeQueryResponseUI()
                  }
                  div[0].appendChild(btn)
                }
                
                div[0].className = "queryStatus"
                document.body.appendChild(innerModal)
                document.body.appendChild(templateClone)
              }

              const removeQueryResponseUI = () => {
                document.querySelector(".queryStatus").remove()
                document.querySelector(".overlay").remove()
              }
              
              //Query form functions--------------------------------------------
              // document.getElementById("field").addEventListener("change", (event)=> {
              //   console.log(event)
              //   document.getElementById("fieldBuilder").textContent = event.target.value
              // })

              // document.getElementById("operator").addEventListener("change", (event)=> {
              //   console.log(event)
              //   document.getElementById("operatorBuilder").textContent = event.target.value
              // })

              // document.getElementById("value").addEventListener("input", (event)=> {
              //   console.log(event)
              //   document.getElementById("valueBuilder").textContent = event.target.value
              // })

              function addCondition() {
                  removeStartUpCondition();
                  const field = document.getElementById('field').value;
                  const operator = document.getElementById('operator').value;
                  const value = document.getElementById('value').value;
                  let currentOperation = `${field} ${operator} ${value}`;
                  let isExist = conditions.find(x => Object.values(x).toString() === currentOperation.split(" ").toString())
                  if(!isExist){
                    conditions.push({ field, operator, value });
                    const li = document.createElement('li');
                    li.textContent = currentOperation
                    document.getElementById('conditions').appendChild(li);
                    document.getElementById("outputFields").disabled = false
                    return
                  }
                return    
              }  

              function clearConditions() {
                  conditions = [];
                  document.getElementById("value").value = ""
                  document.getElementById('conditions').innerHTML = '';
                  document.getElementById('results').innerHTML = '';
                  document.getElementById("results").style.display = "none";
                  document.getElementById("btnToggleTableView").disabled = true;
                  //roadwayInventoryfeatureLayer.visible = false;
                  addStartUpCondition();
              }              
              
              async function runAssetQuery(where, outFields, featLayer){
                queryResponseUI({para: "Hey, Query is doing its thing.", header:"Query Message"}, 0, height="250px", width="350px")
                var query = new Query();
                query.where = where;
                query.outFields = [outFields];
                query.returnGeometry = true; // false = no geometry
                query.supportsPagination = true;
                try{
                  featLayer.definitionExpression = where;
                  let returnQuery = await featLayer.queryFeatures(query)
                  if(!returnQuery.features.length){
                    removeQueryResponseUI()
                    queryResponseUI({para: `Welp, no items were returned.  Update your query and try again.`, header:"Query Message"}, null,  height="250px", width="350px")
                    return
                  }
                  console.log(returnQuery)
                  queryTableResults = returnQuery
                  document.getElementById("btnToggleTableView").disabled = false
                  makeTableFromService(returnQuery);
                  console.log(featLayer)
                  featLayer.visible = true;
                  removeQueryResponseUI()
                }
                catch(err){
                  console.log(err)
                  removeQueryResponseUI()
                  queryResponseUI({para:`Welp, Invalid query. Check your parameters and retry.`, header: "Query Message"}, "button",  height="250px", width="350px") 
                }
              }

              async function setLayerDefinitionExpression(featLayer) {
                resetLRSIdentify();
                var outputFieldsSelect = document.getElementById("outputFields");
                var outputFieldList = Array.from(outputFieldsSelect.selectedOptions).map(option => option.value).join(',');
                var queryWhere = conditions.map(condition => `${condition.field} ${condition.operator} '${condition.value}'`).join(' AND ')
                //roadwayInventoryfeatureLayer.definitionExpression = queryWhere;
                //roadwayInventoryfeatureLayer.visible=true;
                await runAssetQuery(queryWhere, outputFieldList, featLayer)

                featLayer.queryExtent(query).then(function(results){
                  //check extents
                  var extent = results.extent;
                  // var expandedExtent = extent.expand(1.15); // Expand the extent by 15%          
                  view.goTo(results.extent);
                });                
              }

              function getRowInfo(event){
                let evt = event.target;
                let test = []
                console.log(event.target)
                while(evt){
                  test.push(evt.innerHTML)
                  evt = evt.nextElementSibling
                }
                let comparteArr = test.map((x) => {
                  if(!x){
                    return null
                  }
                  return x
                })

                let rowArr = []
                let returnResult = queryTableResults.features.filter((x) => {
                  for(let i in x.attributes){
                    if(typeof(x.attributes[i]) === "number"){
                      x.attributes[i] = x.attributes[i].toString()
                    }
                  }
                  // console.log(JSON.stringify(comparteArr), JSON.stringify(Object.values(x.attributes)))
                  if(JSON.stringify(comparteArr) === JSON.stringify(Object.values(x.attributes))){
                    rowArr.push(x.geometry)
                  }
                  
                })
                console.log(rowArr)

                
                view.goTo(rowArr)


                // while(selectedRow.nextElementSibling != null){
                //   console.log(selectedRow.nextElementSibling.innerHTML)
                //   //rowArr.push(selectedRow.innerHTML)
                //   //rowArr.push(selectedRow.nextElementSibling.innerHTML)
                  
                // }
                // console.log(rowArr)
              }

              async function makeTableFromService(dataArray) {
                  let makeTablePromise = new Promise((res,rej) => {
                    var fieldNames = [];
                    for(var i=0; i<dataArray.fields.length; i++) {
                        fieldNames.push(dataArray.fields[i].name);
                    }
              
                  // Create a table to display the data
                    var table = document.createElement('table');
                    let searchBox = document.createElement("input")
                    searchBox.id = "tableSearch"
                    searchBox.oninput = () => {typeAhead()}
                    table.appendChild(searchBox)
                    table.classList.add("queryTableResults"); 
                    table.setAttribute("id", "queryResultTable");
                  
                    var header = document.createElement('tr');  
                  
                    for (var i=0; i<fieldNames.length; i++) {
                        var th = document.createElement('th');
                        th.classList.add("queryTblHeader");
                        th.textContent = fieldNames[i];
                        th.addEventListener('click', onHeaderClick); // Add click event listener
                        header.appendChild(th);
                    }
                    table.appendChild(header);
                  
                  //Build the table
                    console.log(dataArray.features)
                    for(var i=0; i<dataArray.features.length; i++) {
                        var row = document.createElement('tr');
                        row.addEventListener("click", (evt)=>{
                          getRowInfo(evt)
                        })
                        for (var x in dataArray.features[i].attributes) {
                            
                            td = document.createElement('td');
                            td.textContent = dataArray.features[i].attributes[x];
                            td.classList.add("queryTblData");
                            if(x===0){
                              td.classList.add("esri-icon-zoom-in-magnifying-glass")
                            }
                            row.appendChild(td);                        
                        }
                        table.appendChild(row);
                    }
              
                    var results = document.getElementById('results');
                    results.innerHTML = ''; // Clear previous results
                    results.appendChild(table);
                    document.getElementById("results").style.display = "block";
                    res("table created")
                  })
                // console.log(dataArray);
                  //Get field names
                  return await makeTablePromise
              }               
              
              function sortTable(columnIndex, isAscending) {
                  const table = document.querySelector('#results table');
                  const rows = Array.from(table.rows).slice(1); // Exclude header row
              
                  rows.sort((a, b) => {
                      const aValue = a.cells[columnIndex].textContent;
                      const bValue = b.cells[columnIndex].textContent;
              
                      if (aValue === bValue) {
                          return 0;
                      }
              
                      return (aValue < bValue ? -1 : 1) * (isAscending ? 1 : -1);
                  });
              
                  for (const row of rows) {
                      table.appendChild(row);
                  }
              }
              
              function onHeaderClick(event) {
                  const th = event.target;
                  const isAscending = th.getAttribute('data-sort-order') !== 'asc';
                  const columnIndex = Array.from(th.parentElement.children).indexOf(th);
              
                  sortTable(columnIndex, isAscending);
              
                  // Update the sort order attribute
                  Array.from(th.parentElement.children).forEach(header => header.removeAttribute('data-sort-order'));
                  th.setAttribute('data-sort-order', isAscending ? 'asc' : 'desc');
              }              
              //End query form functions----------------------------------------
              
              //view event to track drawing-------------------------------------
              view.on("click", function(event) {
                var testSketchDiv = document.getElementById("sketchTab");
                if (testSketchDiv.style.display == "block") {
                  
                  document.getElementById("viewDiv").style.cursor = "crosshair"
                  let point = view.toMap({x: event.x, y: event.y});

                  //add graphic to map
                  var pointGraphic = new Graphic({
                        geometry: point,
                        symbol: {
                          type: "simple-marker",
                          color: "red",
                          size: "10px",
                          outline: {
                            color: "red",
                            width: "2px"
                          }
                        }
                  });      
                  
                  graphicsLayer.add(pointGraphic);                  
                  
                  linePoints.push([point.longitude,point.latitude]);
                  if (linePoints.length > 1) {
                    addLine(linePoints);
                  }                  
                }
              });   
              //end view event--------------------------------------------------
              
              //Adding user drawn lines to the map------------------------------
              function addLine(points) {
                var line = new Polyline({
                  paths: [points],
                  spatialReference: { wkid: 4326 }
                });
        
                userDrawnSketchLength = geometryEngine.geodesicLength(line, "miles").toFixed(3);
        
                lineGraphic = new Graphic({
                  geometry: line,
                  symbol: {
                    type: "simple-line",
                    color: "red",
                    width: 4
                  }
                });
        
                graphicsLayer.add(lineGraphic);
              } 
              //End user drawn lines--------------------------------------------
              
              //Sketch Cost-----------------------------------------------------
              function deCalculateCost() {
        				if (userDrawnSketchLength > 0) {
        					//Nothing
        				} else {
        					alert("Please draw a line before calculating costs.");
        					return;
        				}
        
        				var deProjectType = document.getElementById("selPrjType").value;
        				var deAreaType = document.getElementById("selPrjAreaType").value;
        				var deRouteType = document.getElementById("selPrjRouteType").value;
        				var deDivided = document.getElementById("selPrjDividedType").value;
        				var deFrontageRoads = document.getElementById("selPrjFrontageRoads").value;
        				var deLanes = document.getElementById("txtPrjLanes").value;
        				var deProjectLength = Math.round(userDrawnSketchLength * 1000) / 1000;
        
        				if (deLanes < 1) {
        					alert("Number of Lanes must be greater than 0.");
        					return;
        				}
        
        				if (deRouteType == "E") {
        					deDivided = "H";
        				}
        
        				var userProjectInput = deProjectType + deAreaType + deRouteType + deDivided;
        				var codeArray = new Array("ADFH","ADFI","BDFH","BDFI","ADGH","ADGI","BDGH","BDGI","ADEH","BDEH","ACFH","ACFI","BCFH","BCFI","ACGH","ACGI","BCGH","BCGI","ACEH","BCEH");
        				var costArray = new Array(2891181,1523096,679775,410606,1567558,1142895,743221,527346,2500000,585985,3307443,1424801,883591,742257,2948087,1413481,1213519,853382,5463629,917134);
        				var prjCostPerMile;
        
        				var i;
        				for (i = 0; i < 20; i++) {
        					if (userProjectInput == codeArray[i]) {
        						prjCostPerMile = costArray[i];
        					}
        				}
        
        				var totalRoadTypeCost = prjCostPerMile * deLanes * deProjectLength;
        				var totalFrontageRoadCost = 0;
        
        				if (deFrontageRoads == "2") {
        					totalFrontageRoadCost = 1250000 * deProjectLength * 4;
        				} else {
        					totalFrontageRoadCost = 0;
        				}
        
        				//Summing total project cost and writing to output
        				var theOutputArea = document.getElementById("deCostResult");
        				var totalProjectCost = totalRoadTypeCost + totalFrontageRoadCost;
        				totalProjectCost = Math.round(totalProjectCost / 1000) * 1000;
        				theOutputArea.innerHTML =	"<br>Project Length: <br>" + deProjectLength + " miles<br><br>Estimated Construction Cost: <br>$" +	totalProjectCost.toLocaleString();
        			}  
        			//End Sketch Cost-------------------------------------------------
              
              //Export KML------------------------------------------------------
              function exportKML() {
                var graphics = graphicsLayer.graphics.toArray();
                
                var kml = '<?xml version="1.0" encoding="UTF-8"?>' +
                  '<kml xmlns="http://www.opengis.net/kml/2.2">' +
                  '<Document><visibility>1</visibility><open>1</open>';
        
                graphics.forEach(function (graphic) {
                  var geometry = graphic.geometry;
                  var symbol = graphic.symbol;
                  var title = graphic.popupTemplate.title;
                  var content = graphic.popupTemplate.content;
        
                  // Extract line color and width from symbol if it is a SimpleLineSymbol
                  var lineColor, lineWidth;
                  if (symbol instanceof SimpleLineSymbol) {
                    lineColor = symbol.color.toHex();
                    lineWidth = symbol.width;
                  }
                  
                  // Remove the "#" symbol
                  var stringWithoutHash = lineColor.substring(1);
                  
                  // Extract the parts to be swapped
                  var part1 = stringWithoutHash.substring(0, 2); // "00"
                  var part2 = stringWithoutHash.substring(2, 4); // "bf"
                  var part3 = stringWithoutHash.substring(4); // "ff"
                  
                  // Reorder the parts
                  var reorderedString = part3 + part2 + part1;
                  
                  // Append "7f" to the front of the reordered string
                  lineColor = "7f" + reorderedString;                  
        
                  // Build KML for the graphic
                  var graphicKML = '<Placemark>' +
                    '<name>' + title + '</name>' +
                    '<description>' + content + '</description>';
                    
                  // Add line color and width to KML
                  if (lineColor && lineWidth) {
                    graphicKML += '<Style>' +
                      '<LineStyle>' +
                      '<color>' + lineColor + '</color>' +
                      '<width>' + lineWidth + '</width>' +
                      '</LineStyle>' +
                      '</Style>';
                  }                    
        
                  // Add geometry information to KML
                  if (geometry.type === 'polyline') {
                    graphicKML += '<LineString>' + '<coordinates>';
                    
                    geometry.paths[0].forEach(function (vertex) {
                      // Convert Web Mercator coordinates to lat/long
                      var lngLat = webMercatorUtils.xyToLngLat(vertex[0], vertex[1]);
                      var lng = lngLat[0].toFixed(6);
                      var lat = lngLat[1].toFixed(6);
              
                      graphicKML += lng + ',' + lat + ' ';
                    });                    
                    graphicKML += '</coordinates>' + '</LineString>';
                  }
                  graphicKML += '</Placemark>';
                  kml += graphicKML;
                });
        
                kml += '</Document>' + '</kml>';
                downloadFile('export.kml', kml);
              }
              
              // Function to download the KML file
              function downloadFile(filename, content) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
              }
              //End KML Export--------------------------------------------------
              
              //Check diagram fields--------------------------------------------
              function checkLRMInputs() {
                diagramTitle = document.getElementById("inpSRDRouteID").value;
                diagramBeginDFO = Number(document.getElementById("inpSRDFromDFO").value);
                diagramEndDFO = Number(document.getElementById("inpSRDToDFO").value);
                
                //Check that Route input is not empty
                if (document.getElementById("inpSRDRouteID").value.length==0) {
                    alert("Please enter a Route ID in the route field.");
                    document.getElementById("inpSRDRouteID").focus();
                    return;
                }                
                
                //Check that DFO Begin input is not empty
                if (document.getElementById("inpSRDFromDFO").value.length==0) {
                    alert("Please enter a number in the Begin DFO field.");
                    document.getElementById("inpSRDFromDFO").focus();
                    return;
                }
                
                //Check that DFO End input is not empty
                if (document.getElementById("inpSRDToDFO").value.length==0) {
                    alert("Please enter a number in the End DFO field.");
                    document.getElementById("inpSRDToDFO").focus();
                    return;
                }                
                
                //Check that Begin DFO is numeric
                if (isNaN(diagramBeginDFO)) {
                    alert("Please enter a number in the Begin DFO field.");
                    document.getElementById("inpSRDFromDFO").value = "";
                    document.getElementById("inpSRDFromDFO").focus();
                    return;
                }
                
                //Check that End DFO is numberic
                if (isNaN(diagramEndDFO)) {
                    alert("Please enter a number in the End DFO field.");
                    document.getElementById("inpSRDToDFO").value = "";
                    document.getElementById("inpSRDToDFO").focus();
                    return;
                }           
                
                if (diagramBeginDFO>diagramEndDFO) {
                    alert("Begin DFO must be less than End DFO. Please check roadway DFO fields.");
                    document.getElementById("inpSRDFromDFO").focus(); 
                    return;
                }      
                
                //Clearing the LRS identify tools if they area activated
                if (lrsButtonStatus==true) {
                  resetLRSIdentify();
                }              
                
                graphicsLayer.removeAll();
                // inventoryDiagramLog = [];
                // inventoryDiagramLogAllValues = [];                 
                
                //Building the Diagram
                buildDiagram(diagramTitle,diagramBeginDFO,diagramEndDFO);
                //Adding the event to the map
                getLineworkWithM(diagramTitle,diagramBeginDFO,diagramEndDFO,"#000000",6,"Route: "+diagramTitle+"<br>From DFO: "+diagramBeginDFO+"<br>To DFO: "+diagramEndDFO);
              }         
                
              function buildDiagram(diagramTitle,diagramBeginDFO,diagramEndDFO) {
                var canvasParentDiv = document.getElementById("parentCanvas");
                canvasParentDiv.style.display = "block";
                
                // Set the canvas element's dimensions
                var canvas = document.getElementById("myCanvas");
                canvas.width = canvasParentDiv.clientWidth;
                canvas.height = canvasParentDiv.clientHeight; 
                
                maxAttributesOnPage = Math.floor((canvas.height-attributeStartY)/(spacePerAttribute+5)); 
                console.log("Max Attributes: "+maxAttributesOnPage);
                numberOfAttributes=0;
                
                // Get the 2D rendering context of the canvas
                var context = canvas.getContext("2d");
                
                //Draw neatline
                drawPolygon([[0,0],[canvas.width,0],[canvas.width,canvas.height],[0,canvas.height],[0,0]],2,"#FFFFFF","#D3D3D3");
                
                //Draw header
                drawPolygon([[0,0],[canvas.width,0],[canvas.width,30],[0,30],[0,0]],1,"#14375A","#4682B4");
                
                //Ruler variables
                rulerY = 90; // Vertical position of the ruler
                rulerHeight = 20; // Height of the ruler
                rulerMargin = 35; // Margin from left and right borders
                rulerLength = (diagramEndDFO-diagramBeginDFO).toFixed(3); // Length of the ruler in miles  
                rulerWidth = canvas.width - rulerMargin * 2;
                pixelsPerMile = rulerWidth / rulerLength;
                
                //Draw ruler
                drawRectangle(rulerMargin,rulerY,rulerWidth,rulerHeight,"#D3D3D3"); 
                
                // Calculate upper label positions
                labelY = rulerY - rulerHeight / 2 - 20; // Y position for upper labels
                labelPositions = [rulerMargin, rulerMargin + rulerWidth / 4, rulerMargin + rulerWidth / 2, rulerMargin + rulerWidth * 3 / 4, canvas.width - rulerMargin]; // X positions for upper labels
                labelFactor = roundToDecimalPlace((rulerLength/4),3);
                labelValue = diagramBeginDFO;
                 
                //Diagram heading text
                drawText("TxDOT",10,22,"#FFFFFF","18");
                drawTextCenter(diagramTitle,labelPositions[2],22,"#FFFFFF","18");
                
                //Mileage Label
                var txtWidth = context.measureText((diagramEndDFO-diagramBeginDFO).toFixed(3) + " mi.").width;
                drawText((diagramEndDFO-diagramBeginDFO).toFixed(3) + " mi.",canvas.width-(txtWidth*.6),22,"#FFFFFF","18");                
                 
                //DFO Label
                drawTextCenter("DFO",labelPositions[0],labelY-15,"#000000","10");
                
                //Add Datestamp
                const currentDate = new Date();
                
                // Get the individual components of the date
                const month = String(currentDate.getMonth() + 1);
                const day = String(currentDate.getDate());
                const year = String(currentDate.getFullYear());
                
                // Create the date stamp string
                const dateStamp = `${month}/${day}/${year}`;                
                drawText(dateStamp,canvas.width-35,canvas.height-10,"#000000","12");
                drawText("Source: TxDOT Roadway Inventory, TPP-Data Management",170,canvas.height-10,"#000000","12");
                
                //Draw the upper labels and tick marks
                for (let i = 0; i < labelPositions.length; i++) {
                  const labelX = labelPositions[i];
                  //Draw DFO Labels
                  drawTextCenter(roundToDecimalPlace(labelValue,3),labelX,labelY,"#000000",12);
            
                  //Draw tick marks end caps
                  if (i==0||i==labelPositions.length-1) {
                    drawLine(labelX,rulerY-20,labelX,rulerY+40,1,"#000000");
                  } else {
                    //Intermediate DFO
                    drawLine(labelX,rulerY-20,labelX,rulerY,1,"#000000");
                    //Intermediate MPT
                    drawLine(labelX,rulerY+20,labelX,rulerY+40,1,"#FF0000");
                  }
                  
                  labelValue += labelFactor;
                }                
                
                //Draw Multiple Control Sections found
                drawTextCenter("Verifying Control Sections...",labelPositions[2],labelY+115,"#FF0000","12");                
                
                var urlFromDFO = "https://lrs-ext.us-e1.cloudhub.io/api/elrs4?RouteID="+diagramTitle+"&DistanceFromOrigin="+diagramBeginDFO;
                var urlToDFO = "https://lrs-ext.us-e1.cloudhub.io/api/elrs4?RouteID="+diagramTitle+"&DistanceFromOrigin="+diagramEndDFO;
                
                var diagramBMP = "";
                var diagramEMP = "";
                
                request(urlFromDFO)
                  .then(function(response) {
                    console.log(response)
                    //Getting begin CS and BMP
                    diagramCSBegin = [response.data[0].CTRL_SECT_LN_NBR,response.data[0].CTRL_SECT_MPT];

                    //Getting end CS and EMP
                    request(urlToDFO).then(function(response) {
                      diagramCSEnd = [response.data[0].CTRL_SECT_LN_NBR,response.data[0].CTRL_SECT_MPT];
                      
                      //If the Begin and End CS match, call the CS portion of the diagram
                      if (diagramCSBegin[0]===diagramCSEnd[0]) {
                        drawMPTLabels = true;
                        processControlSectionRuler(diagramCSBegin[0],diagramCSBegin[1]);
                      } else {
                        //Add the inventory attributes but don't label milepoints
                        drawMPTLabels = false;
                        
                        //Draw white box to clear loading message
                        drawRectangle(labelPositions[2]-125,labelY+105,250,20,"#FFFFFF");
                        //Draw Multiple Control Sections found
                        inventoryDiagramLogAllValues.length ? drawTextCenter("Multiple Control Sections",labelPositions[2],labelY+115,"#FF0000","12") : drawTextCenter("Unable to draw Control Sections...",labelPositions[2],labelY+115,"#FF0000","12");
                        if (inventoryDiagramLogAllValues.length>0) {
                          //Add inventory attributes from the URL
                          for (var i = 0; i < inventoryDiagramLogAllValues.length; i++) {
                            
                            addInventoryAttribute(inventoryDiagramLogAllValues[i]);
                          }
                        }                    
                      }
                    });                                 
                  })
                  .catch((err) =>{
                    console.log(err)
                  });

              }              
              //End check diagram fields----------------------------------------
              
              function processControlSectionRuler(theCSNBR,theCSBMP) {
                csNBR = theCSNBR;
                beginMPT = theCSBMP;
                var csLabelValue = beginMPT;
                
                //Draw the lower labels and tick marks
                for (let i = 0; i < labelPositions.length; i++) {
                  const labelX = labelPositions[i];
                  //Draw MPT Labels
                  drawTextCenter(roundToDecimalPlace(csLabelValue,3),labelX,labelY+90,"#FF0000",12)                  
                  csLabelValue += labelFactor;
                }                 
                
                //Adding a dash
                csNBR = csNBR.substring(0, 4) + "-" + csNBR.substring(4);
                //Draw white box to clear loading message
                drawRectangle(labelPositions[2]-125,labelY+105,250,20,"#FFFFFF");                
                //Draw Control Section Text
                drawTextCenter("Control Section: "+csNBR,labelPositions[2],labelY+115,"#FF0000","14");  
                //Milepoint Label
                drawTextCenter("Milepoint",labelPositions[0],labelY+105,"#FF0000","10");
                
                if (inventoryDiagramLogAllValues.length>0) {
                  //Add inventory attributes from the URL
                  for (var i = 0; i < inventoryDiagramLogAllValues.length; i++) {
                    addInventoryAttribute(inventoryDiagramLogAllValues[i]);
                  }
                }
              }              
              
              function addInventoryAttribute(inventoryAttribute) {
                if (numberOfAttributes>maxAttributesOnPage) {
                  alert("Maximum number of attributes reached.");
                  return;
                }
          
                inventoryDiagramLog.push(inventoryAttribute[2]);
                var inventoryService = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/" + inventoryAttribute[0] + "/FeatureServer/0";
                
                if (inventoryAttribute[2]=="Reference Markers") {
                  var theFields = "RTE_NM,DFO," + inventoryAttribute[1];                 
                  var theQuery = "RTE_NM='" + diagramTitle + "'" + " AND (DFO < " + diagramEndDFO + " AND DFO > " + diagramBeginDFO + ")";
                  var theOrder = "RTE_NM ASC, DFO ASC";  
                  var theRequestURL = inventoryService + "/query?f=json&orderByFields=" + theOrder + "&returnGeometry=false&where=" + theQuery + "&outFields=" + theFields;                    
                  
                  //Request for Points
                  request(theRequestURL).then(function(response) {
                      processInventoryAttributePoint(response,inventoryAttribute[2]);
                  });                  
                } else {
                  var theFields = "RTE_NM,BEGIN_DFO,END_DFO," + inventoryAttribute[1];                 
                  var theQuery = "RTE_NM='" + diagramTitle + "'" + " AND (BEGIN_DFO < " + diagramEndDFO + " AND END_DFO > " + diagramBeginDFO + ")";
                  var theOrder = "RTE_NM ASC, BEGIN_DFO ASC"; 
                  var theRequestURL = inventoryService + "/query?f=json&orderByFields=" + theOrder + "&returnGeometry=false&where=" + theQuery + "&outFields=" + theFields;                    
                  
                  //Loading status message that get effectively erased
                  drawTextCenter("Loading " + inventoryAttribute[2],labelPositions[2],attributeStartY+(numberOfAttributes*spacePerAttribute)+15,"#000000","10");                  
                  
                  //Request for Lines
                  request(theRequestURL).then(function(response) {
                      processInventoryAttribute(response,inventoryAttribute[2]);
                  });                  
                }
              }
              
              function processInventoryAttributePoint(response,theInventoryLabel) {
                var returnedFeatures = response.data.features;
                var attBeginDFO;
                var attValueGroup;
                var attValue=45;
                var dfoValue;
                var mptValue;
                
                for (var i = 0; i < returnedFeatures.length; i++) {
                  attBeginDFO = returnedFeatures[i].attributes.DFO;
                  attValueGroup = returnedFeatures[i].attributes;
                  
                  const jsonArray = Object.entries(attValueGroup); 
                  
                  for (let j = 0; j < jsonArray.length; j++) {
                    const [key, value] = jsonArray[j];
                    if (key=="RTE_NM"||key=="DFO") {
                      //nothing
                    } else {
                      attValue = value;
                    }
                  }
                  
                  var eventBeginPixelValue = rulerMargin+(pixelsPerMile*(attBeginDFO-diagramBeginDFO));
                  //Draw background rectangle for Marker Number
                  drawRectangle(eventBeginPixelValue-6,attributeStartY-127,12,34,"#008000");
                  attValue = attValue.toString();
                  
                  //Draw stacked text
                  var markerTextStartY = attributeStartY-116;
                  
                  //Offsetting based on marker character length
                  if (attValue.length==1) {
                    markerTextStartY+=10
                  }
                  if (attValue.length==2) {
                    markerTextStartY+=5
                  }
                  
                  for (let j = 0; j < attValue.length; j++) {
                    const character = attValue.charAt(j);
                    drawText(character,eventBeginPixelValue,markerTextStartY,"#FFFFFF",12);
                    markerTextStartY += 10;
                  }                    
                }
              }              
            
              function processInventoryAttribute(response,theInventoryLabel) {
                var returnedFeatures = response.data.features;
                var attBeginDFO;
                var attEndDFO;
                var attValueGroup;
                var attValue;
                var dfoValue;
                var mptValue;
                
                for (var i = 0; i < returnedFeatures.length; i++) {
                  attBeginDFO = returnedFeatures[i].attributes.BEGIN_DFO;
                  attEndDFO = returnedFeatures[i].attributes.END_DFO;
                  attValueGroup = returnedFeatures[i].attributes;
                  
                  const jsonArray = Object.entries(attValueGroup); 
                  
                  for (let j = 0; j < jsonArray.length; j++) {
                    const [key, value] = jsonArray[j];
                    if (key=="RTE_NM"||key=="BEGIN_DFO"||key=="END_DFO") {
                      //nothing
                    } else {
                      attValue = value;
                    }
                  }
                  
                  //Clip to graphic DFO range
                  if (attBeginDFO<diagramBeginDFO) {
                    attBeginDFO=diagramBeginDFO;
                  }
                  if (attEndDFO>diagramEndDFO) {
                    attEndDFO=diagramEndDFO;
                  }                
                  
                  //Selecting alternating colors
                  const [darkColor, lightColor] = diagramColors[numberOfAttributes];
                  const selectedColor = i % 2 === 0 ? lightColor : darkColor;                  
                  
                  var eventBeginPixelValue = rulerMargin+(pixelsPerMile*(attBeginDFO-diagramBeginDFO));
                  var eventEndPixelValue = (pixelsPerMile*(attEndDFO-attBeginDFO));
                  
                  //Draw event
                  drawRectangle(eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute),eventEndPixelValue,20,selectedColor);
                  
                  //If length of event is greater than label for event then draw the label
                  var canvas = document.getElementById("myCanvas");
                  var context = canvas.getContext("2d");
                  var txtWidth = context.measureText(attValue).width+10;

                  if (txtWidth<eventEndPixelValue) {
                    //Draw label for event
                    drawTextCenter(attValue,eventBeginPixelValue+(Math.round(eventEndPixelValue/2)),attributeStartY+(numberOfAttributes*spacePerAttribute)+15,"#FFFFFF",13);                  
                  }
                  
                  if (i>0) {
                    //Draw vertical dividing events
                    drawLine(eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute),eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)+20,1,"#000000");                    
                    
                    //Not drawing labels if event is too small
                    if (txtWidth<eventEndPixelValue) {
                      //Draw DFO label
                      dfoValue = roundToDecimalPlace(((eventBeginPixelValue-rulerMargin)/pixelsPerMile)+diagramBeginDFO,3);
                      drawTextCenter(dfoValue,eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)-3,"#000000",11); 
                      
                      //Draw MPT label
                      if (drawMPTLabels==true) {
                        mptValue = roundToDecimalPlace(((eventBeginPixelValue-rulerMargin)/pixelsPerMile)+beginMPT,3);;
                        drawTextCenter(mptValue,eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)+31,"#FF0000",11);                        
                      }
                    }
                  }
                }
                drawText(theInventoryLabel,95,attributeStartY+(numberOfAttributes*spacePerAttribute)-15,"#000000","10");
                numberOfAttributes+=1;
              }
              
              //Drawing functions-----------------------------------------------
              function drawCircle(begX,begY,theRadius,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.fillStyle = theColor;
                  ctx.arc(begX,begY,theRadius,0,2*Math.PI);
                  ctx.fill();
                  // ctx.stroke();
              }              
              
              function drawRectangle(begX,begY,theWidth,theHeight,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.fillStyle = theColor;
                  ctx.fillRect(begX,begY,theWidth,theHeight);
                  //   ctx.stroke();
              }       
              
              function drawPolygon(theCoords,theWidth,fillColor,outlineColor,theScale) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.scale(theScale, theScale);
                  ctx.beginPath();
                  ctx.lineWidth = theWidth;
              
                  //First point
                  ctx.moveTo(theCoords[0][0],theCoords[0][1]);
              
                  //Remainder of points
                  for (var i = 0; i < theCoords.length; i++) {
                      if (i > 0) {
                          ctx.lineTo(theCoords[i][0],theCoords[i][1]);
                      }
                  }
              
                  //Closing the polygon
                  ctx.closePath();
              
                  //Colors and styles
                  ctx.fillStyle = fillColor;
                  ctx.fill();
                  ctx.strokeStyle = outlineColor;
                  ctx.stroke();
              }      
              
              function drawPoint(begX,begY,theRadius,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.fillStyle = theColor;
                  ctx.arc(begX,begY,theRadius,0,2*Math.PI);
                  ctx.fill();
              }
              
              function drawLine(begX,begY,endX,endY,theWidth,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.lineWidth = theWidth;
                  ctx.moveTo(begX,begY);
                  ctx.lineTo(endX,endY);
                  ctx.strokeStyle = theColor;
                  ctx.stroke();
              }              
              
              function clearDrawings() {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.setTransform(1, 0, 0, 1, 0, 0);
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
              }      
              
              function drawText(theText,theX,theY,theColor,theSize) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.font = theSize + "px sans-serif";
                  ctx.fillStyle = theColor;
                  // ctx.textAlign = "center";
                  ctx.fillText(theText,theX,theY);
              }   
              
              function drawTextCenter(theText,theX,theY,theColor,theSize) {
                  console.log(theText,theX,theY,theColor,theSize)
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.font = theSize + "px sans-serif";
                  ctx.fillStyle = theColor;
                  ctx.textAlign = "center";
                  ctx.fillText(theText,theX,theY);
              }               
              //End drawing functions-------------------------------------------
              
              //Numberic Operations---------------------------------------------
              function roundToDecimalPlace(value,decimals) {
                  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
              }
              
              //Graphic Export Options------------------------------------------
              function exportJPEG() {
                  var exportCanvas = document.getElementById("myCanvas");
                  var dataURL = exportCanvas.toDataURL();
              
                  if (window.navigator.msSaveBlob) {
                      window.navigator.msSaveBlob(exportCanvas.msToBlob(), "exportImage.jpeg");
                  }
                  else {
                      const a = document.createElement("a");
                      document.body.appendChild(a);
                      a.href = exportCanvas.toDataURL('image/jpeg', 1.0);
                      a.download = "exportImage.jpeg";
                      a.click();
                      document.body.removeChild(a);
                  }
              }        
              
              function exportPNG() {
                  var exportCanvas = document.getElementById("myCanvas");
                  var dataURL = exportCanvas.toDataURL();
                  
                  if (window.navigator.msSaveBlob) {
                      window.navigator.msSaveBlob(exportCanvas.msToBlob(), "exportImage.png");
                  }
                  else {
                      const a = document.createElement("a");
                      document.body.appendChild(a);
                      a.href = exportCanvas.toDataURL();
                      a.download = "exportImage.png";
                      a.click();
                      document.body.removeChild(a);
                  }
              }       
              //End Export Options----------------------------------------------

              //Show or Hide Div------------------------------------------------
              function toggleVisibility(theElement) {
                var div = document.getElementById(theElement);
                if (div.style.display === "none") {
                  div.style.display = "block";
                } else {
                  div.style.display = "none";
                }
              }
              //----------------------------------------------------------------

              function resetShareUrl(){

                document.getElementById("previewUrl").textContent = ""
              }
              //Download controls
              function openModal() {
          			document.getElementById("modal").style.display = "block";
          		}
          
          		function closeModal() {
          			document.getElementById("modal").style.display = "none";
          		}
          		
          		function zoomToGraphicExtent() {
                var graphicsExtent = graphicsLayer.graphics.reduce(function(extent, graphic) {
                  return extent ? extent.union(graphic.geometry.extent) : graphic.geometry.extent;
                }, null);
                
                view.goTo(graphicsExtent);                
          		}

              function queryToUrl(textString){
                //openModal();
                  navigator.clipboard.writeText(textString)
                  .then(()=>{
                    queryResponseUI({para: "URL has been copied! Paste and go.", url: textString, header:"Share URL"}, "button",  height="250px", width="350px")
                    document.getElementById("previewUrl").textContent = textString
                  })
                  .catch(err => console.log("exportQuery:", err))
  
                return
              }
          
              //Export Query to URL---------------------------------------------
              function exportQueryToURL() { //bridge, roadway
                var outputFieldsSelect = document.getElementById("outputFields");
                let queryType = getCurrentQuerySelection()
                var outputFieldList = Array.from(outputFieldsSelect.selectedOptions).map(option => option.value).join(',');
                var queryWhere = conditions.map(condition => `${condition.field}${condition.operator}${condition.value}`).join(' AND ');                
                let arrayString = `?queryType=${queryType}&tab=query&query=${outputFieldList}|${queryWhere}`
               
                var fullString = `${window.location.href}${arrayString}`;

                queryToUrl(fullString)
                return
              }
              //----------------------------------------------------------------
              
              //Export Diagram to URL-------------------------------------------
              function exportDiagramToURL () {
                var diagramAttributes = inventoryDiagramLog.join(',');
                var arrayString = "?tab=diagram&diagram=" + diagramTitle + "," + diagramBeginDFO + "," + diagramEndDFO;
                let fullString = `${window.location.href}${arrayString}|${diagramAttributes}`
                
                queryToUrl(fullString)
                return
              }
              //----------------------------------------------------------------
              
              //Export Graphics to URL------------------------------------------
              function exportGraphicsToURL() {
                var outputArray = [];
                var graphics = graphicsLayer.graphics.items;
                if (graphics.length > 0) {
                  for (var i = 0; i< graphics.length; i++) {
                    outputArray.push(graphics[i].attributes);
                  }
                }                
                
                var arrayString = outputArray.map(function(innerArray) {
                  return innerArray.join(",");
                }).join("|");    
                
                arrayString = "?tab=event&event=" + arrayString;
                var replacedString = arrayString.replace(/#/g, "%23");
                replacedString = `${window.location.href}${replacedString}`
                
                queryToUrl(replacedString)
              }  
              //End Export Graphics---------------------------------------------              
              
              function resetLRSIdentify() {
                graphicsLayerLRSIdentify.removeAll();
                resetAllTools();
                clearInnerHTML("mapClickResults");
                lrsButtonStatus=false;                
              }

              //load Table of Contents items
              async function loadTOCContent(){
                const docFrag = document.createDocumentFragment()
                let returnToc = await tocFeatureLayer.queryFeatures()
                returnToc.features.forEach((x)=>{
                  let splitUrl = !x.attributes.url ? null : x.attributes.url.split(",")
                  itemArr.push({name: x.attributes.name, url: splitUrl, tocType: x.attributes.Toc_Type, popup: x.attributes.popup, popupTxt: x.attributes.popupText, defExpress: x.attributes.defExpress,visible: 0})
                })
                createTOC(itemArr, docFrag)  
                await addBasemapAndFeatureToMap(itemArr)
                searchOverlays(docFrag)
              }

              function createTOC(tocObj, documentFrag){
                
                const tocTable = document.getElementById("tocMaps")
                tocTable.innerHTML += `
                  <tr><td id="CLEAR" style="border-left:6px solid #14375A; padding-left: .6rem; background-color:rgba(20,55,90,.2)">Clear Overlays</td></tr>
                  <tbody id="featRow"> 
                  </tbody>
                  <tr><th class="basemapHeader">Additional Overlays</th></tr>
                  <small style="position:relative; left: .3rem;">Select a Feature Layer to add to map:</small>
                  <div class="dropDown">
                  <select name="dropDown" id="layerSearch" placeholder="Search for Layer"></select>
                  </div>
                  <tbody id="addFeatRow"> 
                  </tbody>
                `
                let previousItem
                for(i=0; i < tocObj.length; i++){
                  if(tocObj[i].name === previousItem) continue
                  previousItem = tocObj[i].name
                  if(mainTOCLayers.includes(tocObj[i].name) ){
                    
                    appendChildToOverlayList(tocObj[i].name, tocObj[i].tocType, true, documentFrag)
                    continue
                  }
                  if(tocObj[i].name === "Texas Roadways Unsegmented") continue
                  buildDropDown(tocObj[i].name)
                  //document.getElementById("basemapRow").appendChild(tr)
                }

                document.getElementById("featRow").appendChild(documentFrag)

              } 

              function buildDropDown(name){
                let dropdown = document.getElementById("layerSearch")
                let option = document.createElement("option")
                option.value = name
                option.appendChild(document.createTextNode(name))
                dropdown.appendChild(option)
              }

              function appendChildToOverlayList(layerItem, layerType, initBuild, documentFrag){
                  let noDownload = ["Live Traffic"]
                  let tr = document.createElement("tr")
                  let td = document.createElement("td")
                  td.id = layerItem
                  td.className = "baseMapList"
                  let div = document.createElement("div")
                  div.id = layerItem
                  let dwnloadBtn = document.createElement("button")
                  dwnloadBtn.className = noDownload.includes(layerItem) ? "esri-icon-error noDwnloadBtn" : "esri-icon-download dwnloadBtn"
                  noDownload.includes(layerItem) ? dwnloadBtn.disabled = true : null
                  dwnloadBtn.onclick = () => downloadOverlay(layerItem)
                  if(initBuild === false){
                    let btnDiv = document.createElement("div")
                    btnDiv.id = "rmvDiv"
                    let rmvButton = document.createElement("button")
                    btnDiv.appendChild(rmvButton)
                    rmvButton.className = "esri-icon-close-circled removeOverlay"
                    rmvButton.id = `removeOverlay${layerItem}`
                    td.appendChild(btnDiv)
                  }
                  td.appendChild(dwnloadBtn)
                  div.appendChild(document.createTextNode(layerItem))
                  div.style.width = "80%"
                  td.appendChild(div)

                  tr.appendChild(td)
       
                  if(layerType === "FeatureLayer"){
                    initBuild === false ? document.getElementById("addFeatRow").appendChild(tr) : documentFrag.appendChild(tr)
                    return
                  }
              }

              function removeOverlay(id){
                if(!id) return
                let [idLeft, idRight] = id.split("removeOverlay")
                let url = itemArr.find(name => name.name === idRight)
                let returnfeatLayer = retrieveFeatureLayer(url.name)
                returnfeatLayer.forEach(x => {
                  x.visible = false
                  itemArr.find(y => y.name === x.name).visible = 0
                })
                document.getElementById(idRight).remove()
              }

              function addFeatureLayerToMap(featLayer, popupInfo){
       
                // featLayer.url.forEach((url)=>{
                  let addFeatureLayer = new FeatureLayer({
                    url: featLayer.url,
                    visible: false,
                    outFields: ["*"],
                    name: featLayer.name,
                    popupEnabled: true,
                    popupTemplate: popupInfo,
                    definitionExpression: featLayer.defExpress ?? ""
                  })

                  addFeatureLayer.when((layer)=>{
                  //need to add TxDOT_Top_100_Congested_Roadways, TxDOT_Districts, Texas_County_Boundaries_Detailed, TxDOT_Roadways_Search 
                  if(layer.title === "TxDOT Bridges"){
                    bridgeInventoryFieldsArray = layer.fieldsIndex.uid.split(",")
                  }
  
                  if(addFeatureLayer.name === "Texas Roadways Unsegmented"){
                    addFeatureLayer.visible = true
                    addFeatureLayer.opacity = 0
                    addFeatureLayer.definitionExpression = `RTE_PRFX in ('IH') AND RDBD_TYPE = 'Single Roadbed'`
                    return
                  }
                  createSourcesArr(layer)
                   
                  })
                      //}
                  map.add(addFeatureLayer)
                // })

                return
              }

              async function addBasemapAndFeatureToMap(featLayerUrlArr){
                let addToMapPromise = new Promise(async(res, rej) =>{
                  for(i=0; i < featLayerUrlArr.length; i++){
                  //add Feature Layer Info
                    if(!featLayerUrlArr[i].url) continue //remove once Inrix set up
                    if(featLayerUrlArr[i].tocType === "FeatureLayer" || featLayerUrlArr[i].tocType === "Search"){
                      let popupObj = JSON.parse(featLayerUrlArr[i].popup)
                      let popupObjText = JSON.parse(featLayerUrlArr[i].popupTxt)
                      let popupInfo = await createpopupTemplate(featLayerUrlArr[i].name, popupObj, popupObjText)
                      addFeatureLayerToMap(featLayerUrlArr[i], popupInfo)
                      continue
                    }
                    
                  }
                  res("complete")
                })

                let returnToken = await getInrixToken()
                let inrixUrl = `http://tile-api.inrix.com/v1/tiles/{level}{col}{row}?roadsegmenttype=XDS&opacity=60&FRCLevel=1,2,3&penWidth=4&accessToken=${returnToken}`

                let webLayer = new WebTileLayer({
                  urlTemplate: inrixUrl,
                  subDomains: ["a", "b", "c"],
                  copyright: "TxDOT, INRIX",
                  visible: false,
                  name: "Live Traffic"
                })
                
                webLayer.getTileUrl = (level, col, row) =>{
                  var quadKeys = retrieveQuadKey(level, col, row);
                  var penWidth = 9;
								  var frcLevel = "1,2,3";

                  //Adjust line width and data density by zoom level
                  if (level <= 8) {
                    penWidth = 9;
                    frcLevel = "1";
                  } else if (level > 8 && level <= 10) {
                    penWidth = 9;
                    frcLevel = "1,2";
                  } else if (level > 10 && level <= 12) {
                    penWidth = 9;
                    frcLevel = "1,2,3";
                  } else if (level > 12 && level <= 14) {
                    penWidth = 10;
                    frcLevel = "1,2,3,4";
                  } else {
                    penWidth = 11;
                    frcLevel = "1,2,3,4,5,6,7";
                  }

                  let returnUrl = `https://tile-api.inrix.com/v1/tiles/${quadKeys}?accessToken=${returnToken}&penWidth=${penWidth}&opacity=60&frcLevel=${frcLevel}&roadsegmenttype=XDS`
                   
                  return returnUrl
                }

                map.add(webLayer)
                
                return await addToMapPromise
              }

              function createSourcesArr(featLayer){
                let sourcesObj = [{url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0", name: "TxDOT_Projects", searchFields: ["CONTROL_SECT_JOB"], displayField: "CONTROL_SECT_JOB", outFields: ["CONTROL_SECT_JOB ","DISTRICT_NUMBER ","LAYMAN_DESCRIPTION1","HIGHWAY_NUMBER"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/Texas_County_Boundaries_Detailed/FeatureServer/0", name: "Texas_County_Boundaries_Detailed", searchFields: ["CNTY_NM"], displayField: "CNTY_NM", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Districts/FeatureServer/0", name: "TxDOT_Districts/FeatureServer", searchFields: ["DIST_NM"], displayField: "DIST_NM", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways_Search/FeatureServer/0", name: "TxDOT_Roadways_Search/FeatureServer", searchFields: ["RTE_CNTY"], displayField: "RTE_CNTY", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Top_100_Congested_Roadways/FeatureServer/0", name: "TxDOT_Top_100_Congested_Roadways/FeatureServer", searchFields: ["RANK"], displayField: "RANK", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Highway_Designations/FeatureServer/0", name: "TxDOT_Highway_Designations/FeatureServer", searchFields: ["MO_NBR"], displayField: "MO_NBR", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer/0", name: "TxDOT_Bridges/FeatureServer/0", searchFields: ["BRDG_ID"], displayField: "BRDG_ID", displayField: "BRDG_ID", outFields:["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_City_Boundaries/FeatureServer/0", name: "TxDOT_City_Boundaries", searchFields: ["CITY_NM"], displayField: "CITY_NM", outFields: ["*"]},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0", name: "TxDOT_Control_Sections", searchFields: ["CTRL_SECT_NBR"], displayField: "CTRL_SECT_NBR", outFields: ["*"]}]

                let featLayerPath = featLayer.parsedUrl.path.toLowerCase()
                let src = sourcesObj.find(source => featLayerPath.includes(source.url.toLowerCase()))
                let isInSearch = searchBar.sources.find(x => x.name === featLayer.title)                
                if(!src || isInSearch) return
                let sourceObj = {
                  layer: new FeatureLayer({
                        url: src.url,
                  }),
                  searchFields: src.searchFields,
                  suggestionsEnabled: true,
                  displayField: src.displayField,
                  exactMatch: false,
                  autoSelect: true,
                  maxResults: 6,
                  maxSuggestions: 6,
                  minSuggestCharacters: 0,
                  outFields: src.outFields,
                  name: featLayer.title,
                  resultSymbol: {
                      type: "simple-line",
                      color: "cyan",
                      width: "6px",
                  }
                }
                searchBar.sources.push(sourceObj)
                //console.log(searchSources)
              }

              function searchOverlays(){
                document.getElementById("layerSearch").addEventListener("change", (event)=>{
                  appendChildToOverlayList(event.target.value, "FeatureLayer", false)
                  toggleLayer(event.target.value)
                })
              }

              async function getInrixToken(){
                let urlRequest = `https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/inrix_token_view/FeatureServer/0/query?f=json&orderByFields=token ASC&returnGeometry=false&where=OBJECTID>=0&outFields=*`
                let request = await fetch(urlRequest)
                let returnedItem = await request.json()
                return returnedItem.features[0].attributes.token
              }

              function retrieveQuadKey(zoom,y,x){
                let key = []

								for (let i = zoom; i > 0; i--){
                  let keyVal = 0;
                  let mask = 1 << (i - 1);
                  if ((x & mask) !== 0) {
                    keyVal++;
									}
                  if ((y & mask) !== 0) {
                    keyVal+=2;
                  }
									key.push(keyVal);
								}
                let quadKey = key.join("");
                return quadKey;
              } 
              
              async function createpopupTemplate(titleField, popupInfo, popupText){
                  let template = {
                    title: titleField,
                    content: [{
                      type: "text",
                      text: popupText ? popupText.top : "",
                    },{
                      type: "fields",
                      fieldInfos: []
                    },{
                      type: "text",
                      text: popupText ? popupText.bottom : "",
                    }],

                    expressionInfos:[]
                  }

                  if(!popupInfo) return
                  let fieldName = Object.values(popupInfo)
                  let label = Object.keys(popupInfo)
                  fieldName.forEach((i,x) => {
                    let a;
                    if(i === "sum numbers"){
                      a = {
                      name: `${titleField}Exp${x}`,
                      title: label[x],
                      expression: "SUM([$feature.ev_dc_fast_num, $feature.ev_level1_evse_num, $feature.ev_level2_evse_num])",
                      }
                    }
                    else{
                      a = {
                      name: `${titleField}Exp${x}`,
                      title: label[x],
                      expression: `
                        if(TypeOf($feature.${i}) == "String"){
                          if(Count($feature.${i}) < 2){
                            return "UNKNOWN"
                          }

                          else{
                            return $feature.${i}
                          }
                        }
                        if(TypeOf($feature.${i}) == "Number"){
                          return $feature.${i}
                        }
                        else{
                          return "UNKNOWN"
                        }
                      `,
                      //fieldName: i,
                      //label: label[x]
                      }
                    }
                    template.expressionInfos.push(a)
                    template.content[1].fieldInfos.push({"fieldName": `expression/${titleField}Exp${x}`})
                  })
                  
                  // for(i=0; i < test.length; i++){
                  //   console.log(test[i])
                  //   // let a = {
                  //   //   //fieldName: fieldName[i],
                  //   //   label: label[i]
                  //   // }
                  //   // template.content[0].fieldInfos.push(a)
                  // }
                return template
              }

              async function downloadOverlay(featLayer){
                let noDownload = ["INRIX Traffic"]
                if(noDownload.includes(featLayer)) return
                
                let featList = retrieveFeatureLayer(featLayer)

                for(let i=0; i < featList.length; i++){
                  let returnFetch = await fetch(`https://opendata.arcgis.com/api/v3/datasets/${featList[i].sourceJSON.serviceItemId}_${featList[i].sourceJSON.id}`)
                  let resp = await returnFetch.json()
                  let a = document.createElement("a")
                  a.href = `${resp.meta.request}/downloads/data?format=fgdb&spatialRefId=4326&where=1=1`
                  a.target = "_blank"
                  a.click()
                }

              } 
              
              function displayFeatOnZoom(zoom){
                let zoomLvl = Math.round(zoom)
                let scaleFeatLayer = ["Texas Roadways Unsegmented", "AADT", "Functional Classification & Urban Areas", "Reference Markers", "Control Section", "Speed Limits", "Future Traffic & Percent Truck", "Top 100 Congested Roadways", "Roadway Inventory - On-System Roadbeds", "Cemeteries"]
                
                let roadLayer = retrieveFeatureLayer("Texas Roadways Unsegmented")
                let aadtLayer = retrieveFeatureLayer("AADT")
                let fcLayer = retrieveFeatureLayer("Functional Classification & Urban Areas")
                let refMarkLayer = retrieveFeatureLayer("Reference Markers")
                let controlLayer = retrieveFeatureLayer("Control Sections")
                let speedLayer = retrieveFeatureLayer("Speed Limits")
                let futureLayer = retrieveFeatureLayer("Future Traffic & Percent Truck")
                let top100Layer = retrieveFeatureLayer("Top 100 Congested Roadways")
                let roadInvOnSysLayer = retrieveFeatureLayer("Roadway Inventory - On-System Roadbeds")
                let cemeteryLayer = retrieveFeatureLayer("Cemeteries")

                let buildQuery;

                if(zoomLvl === 5){
                  roadLayer[0].definitionExpression = "RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                  controlLayer[0].definitionExpression = "RTE_PRFX='IH'"
                  speedLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 7"
                  return
                }

                if(zoomLvl === 6){
                  roadLayer[0].definitionExpression = "RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                  controlLayer[0].definitionExpression = "RTE_PRFX='IH'"
                  speedLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 7"
                  return
                }

                if(zoomLvl === 7){
                  roadLayer[0].definitionExpression = "RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                  controlLayer[0].definitionExpression = "RTE_PRFX='IH'"
                  speedLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 7"
                  return
                }

                if(zoomLvl === 8){
                  roadLayer[0].definitionExpression = "RTE_PRFX IN ('IH', 'US') AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                  controlLayer[0].definitionExpression = "RTE_PRFX='IH'"
                  speedLayer[0].definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 7"
                  return
                }

                if(zoomLvl === 9){
                  roadLayer[0].definitionExpression = "RTE_PRFX IN ('IH', 'US', 'SH', 'SL', 'FM', 'RM') AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression ="(RTE_PRFX IN ('IH', 'US') OR F_SYSTEM IN (1,2,3)) AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0'))"
                  controlLayer[0].definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='US')"
                  speedLayer[0].definitionExpression = "RTE_PRFX IN ('IH','US') AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 10"
                  return
                }
                if(zoomLvl === 10){
                  roadLayer[0].definitionExpression = "RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "(RTE_PRFX IN ('IH', 'US') OR F_SYSTEM IN (1,2,3)) AND RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0'))"
                  controlLayer[0].definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='US')"
                  speedLayer[0].definitionExpression = "RTE_PRFX IN ('IH','US') AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                  cemeteryLayer[0].definitionExpression = "Zoom <= 10"
                  return
                }
                if(zoomLvl === 11){
                  roadLayer[0].definitionExpression = "RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SL' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5'))"
                  controlLayer[0].definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='US')"
                  speedLayer[0].definitionExpression = "RTE_PRFX IN ('IH','SH','US','SL') AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US' or SUBSTRING(RIA_RTE_ID,1,2)='SH' or SUBSTRING(RIA_RTE_ID,1,2)='SL' or SUBSTRING(RIA_RTE_ID,1,2)='TL')"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = ""
                  cemeteryLayer[0].definitionExpression = "Zoom <= 16"
                  return
                }
                if(zoomLvl === 12){
                  roadLayer[0].definitionExpression = "RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'"
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = "RDBD_TYPE = 'KG'"
                  refMarkLayer[0].definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SL' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5'))"
                  controlLayer[0].definitionExpression = "RTE_PRFX NOT IN ('CS', 'FC', 'CR', 'FD', 'PR')"
                  speedLayer[0].definitionExpression = "RTE_PRFX IN ('IH','SH','US','SL') AND RDBD_TYPE = 'KG'"
                  futureLayer[0].definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US' or SUBSTRING(RIA_RTE_ID,1,2)='SH' or SUBSTRING(RIA_RTE_ID,1,2)='SL' or SUBSTRING(RIA_RTE_ID,1,2)='TL')"
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = ""
                  cemeteryLayer[0].definitionExpression = "Zoom <= 16"
                  return
                }
                if(zoomLvl === 13){
                  roadLayer[0].definitionExpression = ""
                  aadtLayer[0].definitionExpression = `zLevel < (${zoom} + 1)`
                  fcLayer[0].definitionExpression = ""
                  refMarkLayer[0].definitionExpression = ""
                  controlLayer[0].definitionExpression = "RTE_PRFX <> 'CS'"
                  speedLayer[0].definitionExpression = ""
                  futureLayer[0].definitionExpression = ""
                  top100Layer[0].definitionExpression = ""
                  roadInvOnSysLayer[0].definitionExpression = ""
                  cemeteryLayer[0].definitionExpression = "Zoom <= 16"
                  return
                }

                //returnLayer[0].definitionExpression = buildQuery
                return
              }

              async function basemapFeatureLayerActiveCheck(url){
                //let mapLayer = retrieveFeatureLayer(name)

                let returnStatus = await fetch(url)
                let status = await returnStatus.json()
                if(!status.error) return tileLayerTxDOT
                if(status.error.code >= 404 && status.error.code <= 499){
                  let alertTxt = "One or more layers are currently unavailable. We are aware of the problem and are working to fix it."
                  createServiceDown(alertTxt, "red")
                  //turn on service down div
                  //backupTxdotLayer.visible = true
                  return "https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap_BACKUP/VectorTileServer"
                }
              }
              
              function createServiceDown(text, color){
                let serviceTemp = document.getElementById("serviceDown")
                let serviceTempClone = serviceTemp.content.cloneNode(true)
                let div = serviceTempClone.querySelectorAll("div")
                div[1].textContent = text 
                div[1].style.backgroundColor = color
                document.body.appendChild(serviceTempClone)
              }

              function moveTable(){
                let routeTable = document.getElementById("results")
                var mousePosition;
                var offset = [0,0];
                var isDown = false;


                routeTable.addEventListener('mousedown', function(e) {
                    isDown = true;
                    offset = [
                    routeTable.offsetLeft - e.clientX,
                    routeTable.offsetTop - e.clientY
                    ];
                }, true);

                document.addEventListener('mouseup', function() {
                    isDown = false;
                }, true);

                document.addEventListener('mousemove', function(event) {
                    event.preventDefault();
                    if (isDown) {
                        mousePosition = {
                    
                            x : event.clientX,
                            y : event.clientY
                    
                        };
                        routeTable.style.left = (mousePosition.x + offset[0]) + 'px';
                        routeTable.style.top  = (mousePosition.y + offset[1]) + 'px';
                    }
                }, true);
              }
              document.getElementById("about").addEventListener("click", ()=>{
                aboutModal()
                document.getElementById("closeAbout").addEventListener("click", ()=>{
                  removeQueryResponseUI();
                  appDetailsModal()
                })
              })

              

              function aboutModal(){
                queryResponseUI({para: `
                  The Statewide Planning Map displays data in support of planning operations at TxDOT.
                  <br>
                  <br>
                  Although we try to update information as often as possible, we are not assuming any responsibility for any damages or inaccuracies if you rely on it.
                  <br>
                  <br>
                  We offer no warranty that this application is accurate or complete. The information shown is for informational purposes and may not have been prepared for or be suitable for legal, engineering, or surveying purposes.
                  <br>
                  <br>
                  It does not represent an on-the-ground survey and represents only the approximate relative location of property/administrative boundaries.
                  <br>
                  <br>
                  <b style="font-size:1.2rem">Resouces</b>
                  <br>
                  Download and explore TxDOT GIS Data
                  <br>
                  <a target="_blank" href="https://gis-txdot.opendata.arcgis.com/" style="color:#14375A"><u>Open Data Portal</u></a><br>
                  <a target="_blank" href="https://txdot.maps.arcgis.com/home/index.html" style="color:#14375A"><u>ArcGIS Online</u></a>
                  <br>
                  <br>
                  Explore TxDOT data and maps
                  <br>
                  <a target="_blank" href="https://www.txdot.gov/data-maps.html" style="color:#14375A"><u>https://www.txdot.gov/data-maps.html</u></a>
                  <br>
                  <br>
                  <b style="font-size:1.2rem">Contact Us</b>
                  <br>
                  <a target="_blank" href="mailto:TPP_GIS@txdot.gov" style="color:#14375A"><u>TPP_GIS@txdot.gov</u></a>
                  <br>
                  If you see an error or missing data, you can <a target="_blank" style="color:#14375A;" href="www.txdot.gov"><u>suggest and edit</u></a>.
                  <br>
                  <br>
                  <a id="closeAbout">Version: 4.5.9 Mustange Island</a>

                  `, header:"About the Statewide Planning Map"}, "button", height="714px", width="473px")
              }

              function appDetailsModal(){
                let releaseNotes = ["New Version"]
                queryResponseUI({para: `

                  <ul>
                    <li>"New Version</li>
                  </ul>

                  `, header: "Release Notes"}, "button", height="300px", width="473px")
              }
            // end require - - -        
            });      
        </script>
    </head>
    <body class="main">
        <div id="header">
            <div class="logo">&nbsp;&nbsp;TxDOT - Statewide Planning Map</div>
            <nav>
                <a class="links" target="_blank" title="View the Planning Map Help Document" href="https://txdot.maps.arcgis.com/apps/Cascade/index.html?appid=a9c6a2a7ff7944c19ce532968db96dd8">Help</a>
                <a class="links" id="about" target="_blank" title="About the Planning Map">About</a>
                <a class="links" href="mailto:tpp-gis@txdot.gov" title="Contact TPP-GIS">Contact</a>
                &nbsp;&nbsp;
            </nav>        
        </div>
        <div id="left-div">
            <div id="tabsParent" class="tabsContainer">
                <div class="tabsChild" id="baseMaps" title="Base Maps and Overlays">Map</div>
                <div class="tabsChild" id="dataQuery" title="View Inventory Data">Query</div>
                <div class="tabsChild" id="eventForm" title="Add Lines to the Map">Event</div>                
                <div class="tabsChild" id="roadwayDiagram" title="Create a Simplified Roadway Diagram">SRD</div>                
                <div class="tabsChild" id="graphicSketch" title="Sketch a Route and Estimate Costs">Plan</div>
            </div>
            <div class="tocTabs" id="mapTab">
        			<table id="tocMaps">
        			<tr><th class="basemapHeader">Basemaps</th></tr>
        			<tr><td class="baseMapList" id='txdot'>TxDOT</td></tr>
        			<tr><td class="baseMapList" id='lightgray'>TxDOT Light Gray</td></tr>
        			<tr><td class="baseMapList" id='darkgray'>TxDOT Dark Gray</td></tr>
        			<tr><td class="baseMapList" id='imagery'>Texas Imagery Service</td></tr>        			
        			<tr><td class="baseMapList" id='esristreets'>Esri Streets</td></tr>
        			<tr><td class="baseMapList" id='osm'>Open Street Map</td></tr>
              <tr><th class="basemapHeader clearOverlay">Common Overlays</th></tr>
              
        			
              
        			<!-- <tr><td id='AADT'>AADT</td></tr>
			        <tr><td id='Control_Section'>Control Sections</td></tr>        			
        			<tr><td id='TxDOT_Projects'>TxDOT Projects</td></tr> -->
        			</table>
            </div>
            <div class="tocTabsQuery" id="queryTab">
              <form onsubmit="return false">
                <div id="querySelectionFilter" style="position: relative; bottom: 1rem;">
                  <p style="position: relative; top: 0rem;">Select a layer to query:</p>
                  <div style="position: relative; bottom: .5rem; right: .4rem">
                    <input type="radio" id="ri" class="noDisabled" name="featQuery" value="RoadInventory">
                    <label for="ri">Roadway Query</label>
                    <input id="bridge" class="noDisabled" type="radio" name="featQuery" value="Bridges">
                    <label for="bridge">Bridge Query</label>
                  </div>
                </div>
                Build Query<br><br>
                <select id="field" class="spmDropDown noDisabled1"></select>
                <select id="operator" class="spmDropDown noDisabled1">
                    <option value="" selected>Select an Operator</option>
                    <option value="=">Equals</option>
                    <option value="<>">Does not equal</option>
                    <option value="<">Less than</option>
                    <option value=">">Greater than</option>
                    <option value="<=">Less than or equal to</option>
                    <option value=">=">Greater than or equal to</option>
                    <!--<option value="LIKE">LIKE (use % as a wildcard)</option>-->
                </select>
                <input type="text" id="value" class="noDisabled1" placeholder="Enter a value to query" disabled>
                <button class="queryButtonClass noDisabled1 spmMainBtn" id="btnAddCondition">Add Condition</button>
                <!-- <section><p id="fieldBuilder" class="queryBuilder">i.e EMP</p><p id="operatorBuilder" class="queryBuilder">i.e ></p><p id="valueBuilder" class="queryBuilder">i.e 1244</p></section> -->
                <ul id="conditions" class="noDisabled1">
                  <li>Conditions listed here</li>
                </ul><br>
                Choose Output Fields<br><br>
                <select id="outputFields" multiple size="10" class="spmDropDown noDisabled1" disabled></select>
                <button class="queryButtonClass tableBtn spmMainBtn" id="btnRunQuery">Run Query</button>
                <button class="queryButtonClass tableBtn spmSecondaryBtn" id="btnClearConditions">Clear</button>
                <button class="queryButtonClass spmSecondaryBtn" id="btnToggleTableView" disabled>Show/Hide Table</button>              
                <button class="queryButtonClass tableBtn spmSecondaryBtn" id="btnExportToCSV">Export CSV</button>
                <button id="btnQueryGenerateURL" class="queryButtonClass tableBtn spmSecondaryBtn">Share URL</button>
                
                <template id="queryTemplate">
                  <div>
                    <!-- <h1 style="position:relative; color:white; background-color: #14375A; height: 2rem; bottom: 1.7rem; width: 22.1rem; right:0.6rem; text-align: left; padding-top: .4rem; padding-left: 1rem;">Query Message</h1> -->
                  </div>
                </template>  
              </form>          
            </div>
            <div class="tocTabsDiagram" id="diagramTab">
              <form onsubmit="return false">
                Roadway<br><br>
                <input id="inpSRDRouteID" type="text" value="" placeholder="Route ID - Example: US0290-KG">
                <input id="inpSRDFromDFO" type="text" class="noDisabled1" value="" placeholder="Begin Measure - Example: 15" disabled>
                <input id="inpSRDToDFO" type="text" class="noDisabled1" value="" placeholder="End Measure - Example: 20" disabled>
                <button id="btnUpdateLRM" class="queryButtonClass spmMainBtn" disabled>Add to Diagram</button>

                Inventory
                <select id="riAttributes" name="riAttribute" class="spmDropDown noDisabled1" disabled>
                    TxDOT_Base_Thickness
                    <option value="TxDOT_AADT_SRD,AADT_CUR,AADT" selected>Select an Option</option>
                    <option value="TxDOT_AADT_SRD,AADT_CUR,AADT">Annual Average Daily Traffic 2021</option>
                    <option value="TxDOT_Route_City_SRD,CITY_NM,City Limit">City</option>                    
                    <option value="TxDOT_Route_County_SRD,CNTY_NM,County">County</option>
                    <option value="TxDOT_Route_District_SRD,DIST_NM,District">District</option>
                    <option value="TxDOT_Functional_Classification_SRD,FC_DESC,Functional System">Functional System</option>
                    <option value="TxDOT_Median_Width_SRD,MDN_WIDTH,Median Width">Median Width</option>
                    <option value="TxDOT_Number_of_Through_Lanes_SRD,LANE_CNT,Number of Lanes">Number of Lanes</option> 
                    <option value="TxDOT_Truck_Percent_SRD,TRK_PCT,Percent Truck">Percent Truck 2021</option>
                    <option value="TxDOT_Reference_Markers_SRD,MRKR_NBR,Reference Markers">Reference Markers</option>
                    <option value="TxDOT_Roadbed_Base_SRD,BASE_TYPE_DSCR,Roadbed Base">Roadbed Base</option>
                    <option value="TxDOT_Base_Thickness_SRD,BASE_THCK,Base Thickness">Roadbed Base Thickness</option>
                    <option value="TxDOT_Roadbed_Width_SRD,RDBD_WIDTH,Roadbed Width">Roadbed Width</option>
                    <option value="TxDOT_Minimum_Right_of_Way_Width_SRD,ROW_WIDTH,ROW Width">ROW Width (minimum)</option>
                    <option value="TxDOT_Inside_Shoulder_Width_SRD,WIDTH,Shoulder Width Inside">Shoulder Width Inside</option>
                    <option value="TxDOT_Outside_Shoulder_Width_SRD,WIDTH,Shoulder Width Outside">Shoulder Width Outside</option>                    
                    <option value="TxDOT_Speed_Limits_SRD,SPD_LMT,Speed Limit">Speed Limit</option>
                    <option value="TxDOT_Roadbed_Surface_SRD,SRFC_TYPE,Surface Type">Surface Type</option>                    
                </select> 
                <button id="btnInventoryUpdateLRM" class="queryButtonClass spmMainBtn" disabled>Add to Diagram</button>
                <button id="btnToggleDiagramView" class="queryButtonClass srdBtn spmSecondaryBtn" disabled>Show/Hide Diagram</button>                
                <button id="btnClearDiagramView" class="queryButtonClass srdBtn spmSecondaryBtn" disabled>Clear</button>
                <button id="btnExportPNG" class="queryButtonClass srdBtn spmSecondaryBtn" disabled>Export PNG</button>
                <button id="btnExportJPEG" class="queryButtonClass srdBtn spmSecondaryBtn" disabled>Export JPEG</button> 
                <button id="btnDiagramGenerateURL" class="queryButtonClass srdBtn spmSecondaryBtn" disabled>Share URL</button>
              </form>                
            </div>
            <div class="tocTabsEvent" id="eventTab">
              <form onsubmit="return false">
                Add Events to the Map<br><br>
                <input type="text" id="eventRoute" placeholder="Route ID - Example: US0290-KG" name="RTE_NM"/>
                <input type="number" step="0.001" id="eventBeginDFO" class="noDisabled1" name="BDFO" placeholder="Begin Measure - Example: 15.123" min="0" max="1000" disabled/>
                <input disabled type="number" step="0.001" id="eventEndDFO" class="noDisabled1"name="EDFO" placeholder="End Measure - Example: 20.123" min="0" max="1000"/>
                <select id="eventColors" name="Color" class="spmDropDown noDisabled1" disabled>
                    <option value="" selected>Select a Color</option>
                    <option value="#000000">Black</option>
                    <option value="#cc6600">Brown</option>
                    <option value="#009933">Green</option>
                    <option value="#00bfff">Light Blue</option>
                    <option value="#ff00ff">Magenta</option>
                    <option value="#ff8000">Orange</option>
                    <option value="#ff0000">Red</option>
                    <option value="#14375a">TxDOT Blue</option>
                    <option value="#ffff00">Yellow</option>
                  </select>
                <input type="number" id="eventWidth" class="noDisabled1" name="Width" placeholder="Line Width - Example: 4" min="1" max="8" disabled/>
                <input type="text" id="eventDescription" class="noDisabled1" placeholder="Description for the Pop-Up" name="Desc" disabled/>
                
                <button id="btnEventMap" class="queryButtonClass spmMainBtn">Add to Map</button>  
                <button id="btnRemoveLast" class="queryButtonClass eventBtn spmSecondaryBtn">Remove Last</button>
                <button id="btnRemoveAll" class="queryButtonClass eventBtn spmSecondaryBtn">Clear</button>
                <button id="btnExportToKML" class="queryButtonClass eventBtn spmSecondaryBtn">Export KML</button>                 
                <button id="btnGenerateURL" class="queryButtonClass eventBtn spmSecondaryBtn">Share URL</button>
                <span class="error" id="error"></span>
              </form>                 
            </div>            
            <div class="tocTabsSketch" id="sketchTab">
              <div id="sketchContents">
                * This tool is for planning purposes.  
                It is not a tool for roadway design or engineering purposes.<br><br>  
                Construction cost estimates are calculated using average project cost by type from August 2003 to August 2013 in 2013 dollars.<br><br>  
                Frontage roads assumed two lanes per direction when selected.  
      					<br><br>
    						<select id="selPrjType" name="selPrjType" class="spmDropDown">
    							<option value="A">New Roadway</option>
    							<option value="B">Reconstruction</option>
    						</select>
    						<br>
    						<select id="selPrjAreaType" name="selPrjAreaType" class="spmDropDown">
    							<option value="C">Urban</option>
    							<option value="D">Rural</option>
    						</select>
    						<br>
    						<select id="selPrjRouteType" name="selPrjRouteType" class="spmDropDown">
    							<option value="E">Freeway</option>
    							<option value="F">Arterial</option>
    							<option value="G">Collector</option>
    						</select>
    						<br>
    						<select id="selPrjDividedType" name="selPrjDividedType" class="spmDropDown">
    							<option value="H">Divided</option>
    							<option value="I">Undivided</option>
    						</select>
    						<br>
    						<select id="selPrjFrontageRoads" name="selPrjFrontageRoads" class="spmDropDown">
    							<option value="1">No</option>
    							<option value="2">Yes</option>
    						</select>
    						<br>
    						<input type="number" id="txtPrjLanes" placeholder="Number of Lanes - Example: 4" name="txtPrjLanes">
    						<br>
    						<button id="btnCalcCost" class="queryButtonClass spmMainBtn" title="Estimate Project Cost">Calculate Cost</button>
    						<button id="btnClearProject" class="queryButtonClass spmSecondaryBtn" title="Clear Project">Clear</button>
    						<div id="deCostResult"></div>      					
              </div>
            </div>            
        </div>
        <div id="viewDiv">
            <!--Map Tools-->
            <div id="toolsParent" class="toolsContainer">
                <div class="toolsChild esri-icon-measure" id="measureButton" title="Measure"></div>
                <div class="toolsChild esri-icon-map-pin" id="lrsButton" title="LRS Identify"></div>
                <div class="toolsChild esri-icon-applications" id="googleMaps" title="Jump to Google"></div>
                <div class="toolsChild esri-icon-printer" id="print" title="Print Map"></div>
                <div class="toolsChild esri-icon-layer-list" id="legend" title="View Legend"></div>
            </div>   
            <div id="marginal">
            <!--Map coordinates and scale bar-->
            </div>
            <div id="mapClickResults">
            <!--Measure and LRS results, Legend-->
            </div>     
            <div id="searchTool" title="Search Tool" class="esri-icon-search toolsChild"></div>
            <div id="searchBox"></div>
            <div id="resetMap" title="Clear and reset map">&#x21BB;</div>
            <button class="hamburgler toolsChild esri-icon-drag-horizontal"></button>
            <div id="results" class="resizeTable">Build a query and view the results here...</div>
            <div id="parentCanvas">
    			      <canvas id="myCanvas">
                    <!--custom graphics here-->
                </canvas>
            </div>  
            <!-- <div id="modal" class="modal">
          		<div class="modal-content">
                <h2 style="color:white; background-color: #14375A; position:relative; bottom: 2rem; padding-left: 1rem; padding-right: 1rem; padding-top:.6rem; height: 2rem;">
                  Share URL
                </h2>
                    <p style="position:relative; bottom: 2rem; left: .8rem; padding-left: 1rem; padding-right: 1rem;">URL has been copied! Paste and go.</p>
                    <p style="position:relative; left: 2rem; bottom: 1.5rem;" >Preview Url:</p>
                    <textarea id="previewUrl" disabled></textarea>
                    <button class="spmMainBtn" id="spnClose">CLOSE</button>
          		</div>
          	</div> -->
            <template id="serviceDown">
              <div class="esri-icon-notice-triangle" >
                <div id="serviceDownDiv"></div>
              </div>
            </template>           
        </div>
    </body>

</html>
